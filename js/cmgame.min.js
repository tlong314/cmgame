/**
 * CMGame
 * A JS engine for games inspired by college math.
 *
 * @author Tim S. Long, PhD
 * @copyright 2021 Tim S. Long, PhD
 */
"use strict";Math.TAU=Math.TAU||2*Math.PI,Math.SQRT3=Math.SQRT3||Math.sqrt(3),Math.SQRT5=Math.SQRT5||Math.sqrt(5),Math.PHI=Math.PHI||.5*(1+Math.SQRT5),window.requestNextFrame=window.requestAnimationFrame,window.cancelNextFrame=window.cancelAnimationFrame,document.body?window.documentBody=document.body:(window.documentBody=document.body=document.documentElement.appendChild(document.createElement("body")),console.warn("Some issues may arise without certain HTML tags present. If you need touch/mouse events, provide either a <body> tag or a <canvas> tag in your HTML.")),window.CM_SILENCE_PATH="js/cmgame/audio/silencesecond.wav";const CMSound=function(){let t=new Audio;t.src=window.CM_SILENCE_PATH;let e=!1,i=!1,s={};const n=new Map,a=new(window.AudioContext||window.webkitAudioContext);let h=!1;async function o(t,e=null){if(n.has(t))return n.get(t);const i=await fetch(t),s=await i.arrayBuffer();let h;try{h=await a.decodeAudioData(s)}catch(t){h=await function(t){return new Promise((e,i)=>{a.decodeAudioData(t,t=>e(t),t=>i(t))})}(s)}return n.set(e||t,h),h}function r(t,e){return n.has(t)?(s[t]=a.createBufferSource(),s[t].loop=!!e,s[t].buffer=n.get(t),s[t].connect(a.destination),s[t].start(),s[t]):o(t).then(i=>(s[t]=a.createBufferSource(),s[t].loop=!!e,s[t].buffer=i,s[t].connect(a.destination),s[t].start(),s[t]))}return function(){if(h)return;const s=a.createBuffer(1,1,22050),n=function(o){t.onended=function(){var t=a.createBufferSource();t.buffer=s,t.connect(a.destination),t.start(0),"function"==typeof a.resume&&a.resume(),t.onended=function(){t.disconnect(0),h=!0,document.removeEventListener("touchstart",n,!0),document.removeEventListener("touchend",n,!0),document.removeEventListener("click",n,!0),i||(i=!0)}},e||(e=!0,t.play())};document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0)}(),{play:r,pause:function(t){void 0!==s[t]&&s[t].stop()},stop:function(t){void 0!==s[t]&&s[t].stop(0)},load:o,loop:function(t){return r(t,!0)}}}();class CMRandom{constructor(){let t=function*(){for(;;)yield CMRandom.range(1-2**31,2**31)}();this.nextInt=function(e){if(void 0!==e){if(e<0)throw new Error("CMRandom.nextInt must take nonnegative bound (or no bound)");return CMRandom.range(0,e)}return t.next().value};let e=function*(){for(;;)yield!!CMRandom.range(0,2)}();this.nextBoolean=function(){return e.next().value}}}CMRandom.range=((t,e)=>Number.isInteger(t)&&Number.isInteger(e)?t+Math.random()*(e-t)>>0:t+Math.random()*(e-t)),CMRandom.nonzero=((t,e)=>{if(t>0||e<0)return CMRandom.range(t,e);let i=0;if(Number.isInteger(t)&&Number.isInteger(e))return(i=CMRandom.range(t,e-1))>=0&&i++,i;for(;0===i;)i=t+Math.random()*(e-t);return i}),Object.defineProperties(CMRandom,{radian:{get:function(){let t=CMRandom.range(0,Math.TAU);return t>=Math.TAU&&(t=0),t}},degree:{get:function(){return CMRandom.range(0,360)}},value:{get:function(){return parseFloat(Math.random().toFixed(7))}},color:{get:function(){let t=Object.keys(CMGame.Color).filter(t=>-1===t.indexOf("TRANS"));return CMGame.Color[t[CMRandom.range(0,t.length)]]}},colorscale:{get:function(){let t=Object.keys(CMGame.Color).filter(t=>!t.match(/GRAY|BLACK|WHITE|TRANS/));return CMGame.Color[t[CMRandom.range(0,t.length)]]}},grayscale:{get:function(){let t=Object.keys(CMGame.Color).filter(t=>!!t.match(/GRAY|BLACK|WHITE/));return CMGame.Color[t[CMRandom.range(0,t.length)]]}},sign:{get:function(){return(-1)**CMRandom.range(0,2)}}}),Object.defineProperty(CMRandom,"boolean",{get:function(){return!!(2*Math.random()>>0)}});class CMPoint{constructor(t=0,e=0,i=0){if(this.x=t,this.y=e,this.z=i,"object"==typeof t){let e=t;this.x=e.x||0,this.y=e.y||0,this.z=e.z||0}}isPoint(t){return!!t&&(this.x===t.x&&this.y===t.y&&(this.z===t.z||0===this.z&&void 0===t.z))}isAlmost(t){let e=void 0===t.z?0:t.z;return this.game.roundSmall(this.x-t.x)&&this.game.roundSmall(this.y-t.y)&&this.game.roundSmall(this.z-e)}}let domLoaded=!1,numAudiosToLoad=0,numAudiosLoaded=0,numImagesToLoad=0,numImagesLoaded=0;class CMImage extends Image{constructor(t){super(),numImagesToLoad++;let e=document.getElementById("cmLoadingProgress");null!==e&&e.setAttribute("max",numImagesToLoad+numAudiosToLoad+1),this.onload=registerImageLoad,this.src=t}}class CMAudio extends Audio{constructor(t,e,i){super(),numAudiosToLoad++;let s=document.getElementById("cmLoadingProgress");null!==s&&s.setAttribute("max",numImagesToLoad+numAudiosToLoad+1),this.oncanplaythrough=registerAudioLoad,this.src=t,this.load();let n=CMGame.trimFilename(t);"string"==typeof e?(i.audioMap.set(e,this),CMSound.load(t,e)):(i.audioMap.set(n,this),CMSound.load(t))}}const incrementLoadingProgress=()=>{let t=document.getElementById("cmLoadingProgress");null!==t&&(t.value=parseInt(t.value)+1)},initializeIfReady=()=>{if(incrementLoadingProgress(),numImagesLoaded===numImagesToLoad&&numAudiosLoaded===numAudiosToLoad&&domLoaded){CMGame.resourcesLoaded=!0,CMGame.onresourcesload();let t=document.getElementById("cmLoading");null!==t&&(t.addEventListener("animationend",e=>{t.parentNode.removeChild(t)},!1),t.classList.add("cm-intro-fade"))}},registerImageLoad=()=>{this.loaded=!0,numImagesLoaded++,initializeIfReady()},registerAudioLoad=()=>{this.loaded=!0,numAudiosLoaded++,initializeIfReady()};class CMDoodle{constructor(t,e){this.game=t;let i={},s={startPoint:null,lineWidth:Math.max(t.ctx.lineWidth,1),strokeStyle:CMGame.Color.BLACK,fillStyle:CMGame.Color.TRANSPARENT,fillStyleAbove:CMGame.Color.TRANSPARENT,fillStyleBelow:CMGame.Color.TRANSPARENT,fillStyleLeft:CMGame.Color.TRANSPARENT,fillStyleRight:CMGame.Color.TRANSPARENT};for(let t in s)void 0!==e[t]?i[t]=e[t]:i[t]=s[t];this.startPoint=i.startPoint,this.lineWidth=i.lineWidth,this.strokeStyle=i.strokeStyle,this.fillStyleAbove=i.fillStyleAbove,this.fillStyleBelow=i.fillStyleBelow,this.fillStyleLeft=i.fillStyleLeft,this.fillStyleRight=i.fillStyleRight,this.fillStyle=i.fillStyle,this.points=[this.startPoint],this.path=new Path2D,this.path.moveTo(this.startPoint.x,this.startPoint.y),this.pathAbove=new Path2D,this.pathBelow=new Path2D,this.pathLeft=new Path2D,this.pathRight=new Path2D,t.currentDoodle=this}clear(){this.path=new Path2D,CMGame.clearAll(this.points),this.game.doodles.splice(this.game.doodles.indexOf(this),1)}addPoint(t,e){let i={};i="number"==typeof t?{x:t,y:e}:t,this.points[this.points.length-1].isPoint(this)||(this.points.push(new CMPoint(i)),this.path.lineTo(i.x,i.y),this.rebuildFilledPaths())}removePoint(t,e){let i={};i="number"==typeof t?{x:t,y:e}:t,this.points.splice(this.points.findIndex(t=>t.x===i.x&&t.y===i.y),1),this.rebuildPath(),this.rebuildFilledPaths()}intersectsPoint(t,e){let i={};i="number"==typeof t?{x:t,y:e}:t,this.game.ctx.save(),this.game.ctx.lineWidth=this.lineWidth;let s=game.ctx.isPointInStroke(this.path,i.x,i.y);return this.game.ctx.restore(),s}containsPoint(t,e){let i={};i="number"==typeof t?{x:t,y:e}:t,this.game.ctx.save(),this.game.ctx.lineWidth=this.lineWidth;let s=game.ctx.isPointInPath(this.path,i.x,i.y);return this.game.ctx.restore(),s}rebuildPath(){this.path=new Path2D,this.path.moveTo(this.startPoint.x,this.startPoint.y);for(let t=1;t<this.points.length;t++)this.path.lineTo(this.points[t].x,this.points[t].y)}rebuildFilledPaths(){let t=this.game.canvas,e=this.game.ctx,i=this.points[0],s=this.points[this.points.length-1],n=[i,s].sort((t,e)=>t.x-e.x)[0],a=[i,s].sort((t,e)=>e.x-t.x)[0],h=[i,s].sort((t,e)=>t.y-e.y)[0],o=[i,s].sort((t,e)=>e.y-t.y)[0];this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),i.x<=s.x?(this.pathBelow.lineTo(a.x,t.height+e.lineWidth),this.pathBelow.lineTo(n.x,t.height+e.lineWidth),this.pathBelow.closePath()):(this.pathBelow.lineTo(n.x,t.height+e.lineWidth),this.pathBelow.lineTo(a.x,t.height+e.lineWidth),this.pathBelow.closePath()),this.pathBelow.closePath()),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),i.x<=s.x?(this.pathAbove.lineTo(a.x,0-e.lineWidth),this.pathAbove.lineTo(n.x,0-e.lineWidth)):(this.pathAbove.lineTo(n.x,0-e.lineWidth),this.pathAbove.lineTo(a.x,0-e.lineWidth)),this.pathAbove.closePath()),this.fillStyleLeft&&this.fillStyleLeft!==CMGame.Color.TRANSPARENT&&(this.pathLeft=new Path2D(this.path),i.y<=s.y?(this.pathLeft.lineTo(-e.lineWidth,o.y),this.pathLeft.lineTo(-e.lineWidth,h.y)):(this.pathLeft.lineTo(-e.lineWidth,h.y),this.pathLeft.lineTo(-e.lineWidth,o.y)),this.pathLeft.closePath()),this.fillStyleRight&&this.fillStyleRight!==CMGame.Color.TRANSPARENT&&(this.pathRight=new Path2D(this.path),i.y<=s.y?(this.pathRight.lineTo(t.width+e.lineWidth,o.y),this.pathRight.lineTo(t.width+e.lineWidth,h.y)):(this.pathRight.lineTo(t.width+e.lineWidth,h.y),this.pathRight.lineTo(t.width+e.lineWidth,o.y)),this.pathRight.closePath())}draw(t){t.save(),this.pathLeft&&(t.fillStyle=this.fillStyleLeft,t.fill(this.pathLeft)),this.pathRight&&(t.fillStyle=this.fillStyleRight,t.fill(this.pathRight)),this.pathAbove&&(t.fillStyle=this.fillStyleAbove,t.fill(this.pathAbove)),this.pathBelow&&(t.fillStyle=this.fillStyleBelow,t.fill(this.pathBelow)),this.points.length>1?(t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,this.fillStyle&&this.fillStyle!==CMGame.Color.TRANSPARENT&&(t.fillStyle=this.fillStyle,t.fill(this.path)),t.stroke(this.path)):1===this.points.length&&(t.fillStyle=this.strokeStyle,t.fillRect(this.points[0].x,this.points[0].y,.5*this.lineWidth,.5*this.lineWidth)),t.restore()}}class CMSwipe{constructor(t,e,i,s,n){this.game=t,this.newX=e,this.newY=i,this.oldX=s,this.oldY=n,this.direction=this.getDirection(s,n,e,i),this.direction8=this.getDirection8(s,n,e,i),t.latestSwipes.push(this),t.latestSwipeStrings.push(this.direction),t.latestSwipeStrings8.push(this.direction8),t.latestSwipePath.length&&this.direction===CMGame.last(t.latestSwipePath)||t.latestSwipePath.push(this.direction),t.latestSwipePath8.length&&this.direction8===CMGame.last(t.latestSwipePath8)||t.latestSwipePath8.push(this.direction8)}getDirection(t,e,i,s){let n=this.game.toPolar(new CMPoint(i-t,s-e)).theta;return n>=1.75*Math.PI||n<.25*Math.PI?this.direction="right":n>=.25*Math.PI&&n<.75*Math.PI?this.direction="down":n>=.75*Math.PI&&n<1.25*Math.PI?this.direction="left":n>=1.25*Math.PI&&n<1.75*Math.PI&&(this.direction="up"),this.direction}getDirection8(t,e,i,s){let n=this.game.toPolar(new CMPoint(i-t,s-e)).theta,a=Math.PI/8;return n>=15*a||n<1*a?this.direction8="right":n>=1*a&&n<3*a?this.direction8="downright":n>=3*a&&n<5*a?this.direction8="down":n>=5*a&&n<7*a?this.direction8="downleft":n>=7*a&&n<9*a?this.direction8="left":n>=9*a&&n<11*a?this.direction8="upleft":n>=11*a&&n<13*a?this.direction8="up":n>=13*a&&n<15*a&&(this.direction8="upright"),this.direction8}}class CMGame{constructor(t={}){let e=this;if(this.images={},this.audios={},this.audioMap=new Map,Array.isArray(t.images))for(let e=0;e<t.images.length;e++){let i=CMGame.trimFilename(t.images[e]);this.images[e]=this.images[i]=new CMImage(t.images[e])}else for(let e in t.images)this.images[e]=new CMImage(t.images[e]);if(Array.isArray(t.audios))for(let e=0;e<t.audios.length;e++){let i=CMGame.trimFilename(t.audios[e]);this.audios[e]=this.audios[i]=new CMAudio(t.audios[e],null,this)}else for(let e in t.audios)this.audios[e]=new CMAudio(t.audios[e],e,this);if(void 0===t.overrideStyles&&![...document.styleSheets].find(t=>t.href.match("cmgame.css"))){let t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href="css/cmgame.css",document.head.appendChild(t),console.warn('No path to CMGame stylesheet provided. For best results, add the following code inside your <head></head> tags:\n\n<link rel="stylesheet" href="js/cmgame/css/cmgame.css" />\n\n')}if(!document.querySelector("meta[name='viewport']")){let t=document.createElement("meta");t.name="viewport",t.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0",document.head.appendChild(t),console.warn('No "meta" viewport tag provided. For best appearance before load, add the following code inside your <head></head> tags:\n\n<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0" />\n\n')}switch(this.soundOn=t.soundOn||!1,this.musicOn=t.musicOn||!1,this.orientation=t.orientation||null,this.saveName=t.saveName||"",this.state={},this.multiTouch=!!t.multiTouch,this.gridStyle=CMGame.Color.LIGHT_GRAY,this.xAxisStyle=CMGame.Color.GRAY,this.yAxisStyle=CMGame.Color.GRAY,this.tickStyle=CMGame.Color.DARK_GRAY,void 0!==t.gridStyle&&(this.gridStyle=t.gridStyle),void 0!==t.xAxisStyle&&(this.xAxisStyle=t.xAxisStyle),void 0!==t.yAxisStyle&&(this.yAxisStyle=t.yAxisStyle),void 0!==t.tickStyle&&(this.tickStyle=t.tickStyle),this.fullscreen=!1,void 0!==t.fullscreen&&(this.fullscreen=t.fullscreen),this.type=t.type||"graph",this.ignoreNumLock=!1,void 0!==t.ignoreNumLock&&(this.ignoreNumLock=!!t.ignoreNumLock),this.originByRatio=t.originByRatio||[.5,.5],this.sprites=[],this.functions=[],this.tickDistance="number"==typeof t.tickDistance?t.tickDistance:20,this.graphScalar=t.graphScalar||this.tickDistance,this.screenScalar=1,this.mouseState=new Array(5).fill(0),this.mouseStateString="00000",this.started=!1,this.paused=!1,this.animFrameId=null,this.gameOver=!1,this.frameCount=0,this.frameCap="number"==typeof t.frameCap?t.frameCap:1e3,this.leftMousePressed=!1,this.rightMousePressed=!1,this.middleMousePressed=!1,this.trackedScreenTouches={},this.numPressPoints=0,this.latestPoint=null,this.latestSwipes=[],this.latestSwipeStrings=[],this.latestSwipeStrings8=[],this.latestSwipePath=[],this.latestSwipePath8=[],this.hideOnStart=t.hideOnStart||[],this.wrapper=null,typeof t.wrapper){case"object":this.wrapper=t.wrapper;break;case"string":this.wrapper=document.querySelector(t.wrapper),null===this.canvas&&console.error(t.wrapper+" is not a valid CSS selector, or returned null");break;default:this.wrapper=document.getElementById("cmWrapper")}switch(this.wrapper||(this.wrapper=document.createElement("div"),this.wrapper.setAttribute("id","cmWrapper"),documentBody.appendChild(this.wrapper)),this.canvas=null,typeof t.canvas){case"object":this.canvas=t.canvas;break;case"string":this.canvas=document.querySelector(t.canvas),null===this.canvas&&console.error(t.canvas+" is not a valid CSS selector, or returned null");break;default:this.canvas=document.getElementById("cmCanvas")||document.querySelector("canvas")}switch(this.canvas?(void 0===t.width&&(t.width=this.canvas.width),void 0===t.height&&(t.height=this.canvas.height)):(this.canvas=document.createElement("canvas"),t.width=t.width||640,t.height=t.height||480,this.canvas.classList.add("cm-shadow-almost_black")),this.canvas.hasAttribute("id")||this.canvas.setAttribute("id","cmCanvas"),this.canvas.parentNode!==this.wrapper&&this.wrapper.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.backgroundCanvas=null,typeof t.backgroundCanvas){case"object":this.backgroundCanvas=t.backgroundCanvas;break;case"string":this.backgroundCanvas=document.querySelector(t.backgroundCanvas),null===this.backgroundCanvas&&console.error(t.backgroundCanvas+" is not a valid CSS selector, or returned null")}if(this.backgroundCanvas?this.backgroundCtx=this.backgroundCanvas.getContext("2d"):this.backgroundCtx=null,this.canvasReferenceWidth=t.width||640,this.canvasReferenceHeight=t.height||480,this.width=this.canvasReferenceWidth,this.height=this.canvasReferenceHeight,this.canvas.style.width=this.width+"px",this.canvas.style.height=this.height+"px",this.canvas.width=this.width,this.canvas.height=this.height,this.backgroundCanvas&&(this.backgroundCanvas.style.width=this.width+"px",this.backgroundCanvas.style.height=this.height+"px",this.backgroundCanvas.width=this.width,this.backgroundCanvas.height=this.height),this.devicePixelRatio=window.devicePixelRatio||1,this.offscreenCanvas=document.createElement("canvas"),this.offscreenCtx=this.offscreenCanvas.getContext("2d"),this.offscreenCanvas.style.width=this.width+"px",this.offscreenCanvas.style.height=this.height+"px",this.offscreenCanvas.width=Math.floor(this.canvas.width*this.devicePixelRatio),this.offscreenCanvas.height=Math.floor(this.canvas.height*this.devicePixelRatio),this.origin=null,Array.isArray(t.origin)?this.origin=new CMPoint(t.origin[0],t.origin[1],0):"object"==typeof t.origin?this.origin=new CMPoint(t.origin.x,t.origin.y,0):this.origin=new CMPoint(this.originByRatio[0]*this.width,this.originByRatio[1]*this.height),this.center=Object.freeze(new CMPoint(.5*this.width,.5*this.height)),!t.allowContextMenu){let t=function(t){return t.preventDefault(),t.stopPropagation(),t.cancelBubble=!0,t.returnValue=!1,!1};this.runningAndroid=!!window.navigator.userAgent.match(/android/gi),this.runningAndroid||(window.addEventListener("contextmenu",t,!1),this.canvas.addEventListener("contextmenu",t,!1)),this.running_iOS=!!(/ipad|iphone|ipod/gi.test(navigator.userAgent)||navigator.userAgent.includes("Mac")&&"ontouchend"in document||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1||window.navigator.platform.match(/ipad|iphone|ipod/gi))&&!window.MSStream,this.supportsPassive=!1,this.passiveFlag=!1;try{let t=Object.defineProperty({},"passive",{get:function(){e.supportsPassive=!0,e.running_iOS||(e.passiveFlag={passive:!0})}});window.addEventListener("passivetest",null,t),window.removeEventListener("passivetest",null,t)}catch(t){}}switch(this.pressElement=null,typeof t.pressElement){case"object":this.pressElement=t.pressElement;break;case"string":this.pressElement=document.querySelector(t.pressElement);break;default:this.pressElement=this.canvas}switch(this.pressElement.addEventListener("touchstart",e.touchStart.bind(e),e.passiveFlag),this.pressElement.addEventListener("mousedown",e.mouseDown.bind(e),!1),this.pressElement.addEventListener("touchmove",e.touchMove.bind(e),e.passiveFlag),this.pressElement.addEventListener("mousemove",e.mouseMove.bind(e),!1),this.pressElement.addEventListener("touchend",e.touchEnd.bind(e),!1),this.pressElement.addEventListener("mouseup",e.mouseUp.bind(e),!1),this.pressElement.addEventListener("click",e.click.bind(e),!1),this.pressElement.addEventListener("dblclick",e.dblClick.bind(e),!1),window.addEventListener("keydown",e.keyDown.bind(e),!1),window.addEventListener("keyup",e.keyUp.bind(e),!1),window.addEventListener("resize",e.resizeCanvas.bind(e),!1),this.resizeCanvas.call(this),this.orientationLock=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation||null,!this.orientationLock&&screen.orientation&&(this.orientationLock=screen.orientation.lock||CMGame.noop),this.runCycle=this.updateAndDraw.bind(this),this.startBtn=null,typeof t.startBtn){case"object":this.startBtn=t.startBtn;break;case"string":this.startBtn=document.querySelector(t.startBtn);break;default:this.startBtn=this.canvas}switch(this.startBtn.addEventListener("click",t=>{t.preventDefault(),e.start()},!1),this.enterFullscreenBtn=null,this.exitFullscreenBtn=null,typeof t.enterFullscreenBtn){case"object":this.enterFullscreenBtn=t.enterFullscreenBtn,void 0===this.fullscreen&&(this.fullscreen=!0);break;case"string":this.enterFullscreenBtn=document.querySelector(t.enterFullscreenBtn),void 0===this.fullscreen&&(this.fullscreen=!0);break;default:this.enterFullscreenBtn=this.startBtn}switch(typeof t.exitFullscreenBtn){case"object":this.exitFullscreenBtn=t.exitFullscreenBtn;break;case"string":this.exitFullscreenBtn=document.querySelector(t.exitFullscreenBtn);break;default:this.exitFullscreenBtn=null}this.fullscreen&&(this.enterFullscreenBtn.addEventListener("click",t=>{t.preventDefault(),e.enterFullscreen(e.orientation)},!1),this.exitFullscreenBtn&&this.exitFullscreenBtn.addEventListener("click",t=>{t.preventDefault(),e.exitFullscreen()},!1)),this.screenshotLink=document.createElement("a"),this.screenshotLink.href="",this.screenshotLink.download="cmgscreenshot.png",this.screenshotLink.style.display="none",documentBody.appendChild(this.screenshotLink),this.screenshotBtn=null,t.screenshotBtn&&(this.screenshotBtn=document.querySelector(t.screenshotBtn),this.screenshotBtn.addEventListener("click",t=>{t.preventDefault(),e.takeScreenshot()},!1)),this.videoRecorder=null,this.screenVideoLink=document.createElement("a"),this.screenVideoLink.href="",this.screenVideoLink.download="cmgscreenvideo.mp4",this.screenVideoLink.style.display="none",documentBody.appendChild(this.screenVideoLink),"none"===this.type&&(this.draw=function(t=this.offscreenCtx){t.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.onbeforedraw(t);for(let e of this.sprites)e.draw(t);for(let e of this.doodles)e.draw(t);this.ondraw(t),this.recordingVideo&&(this.screenVideoCtx.clearRect(game.canvas,0,0,this.screenVideoCanvas.width,this.screenVideoCanvas.height),this.screenVideoCtx.drawImage(game.canvas,this.screenVideoDetails.x,this.screenVideoDetails.y,this.screenVideoDetails.width,this.screenVideoDetails.height))}),this.vennSets=null,this.vennRegions=null,this.vertices=[],this.edges=[],"venn"===this.type?(this.vennSets=new Map,this.vennRegions=new Map,this.setNumberOfSets(t.numSets||0,t.variation||0),this.update=function(){this.onbeforeupdate(this.frameCount),this.frameCount++,this.frameCount>this.frameCap&&(this.frameCount=0);for(let[t,e]of this.vennRegions)e.update();for(let[t,e]of this.vennSets)e.update();for(let t of this.sprites)t.update(this.frameCount);this.onupdate(this.frameCount)},this.draw=function(t=this.offscreenCtx){t.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.onbeforedraw(t);for(let[e,i]of this.vennRegions)i.draw(t);for(let[e,i]of this.vennSets)i.draw(t);t.fillStyle=CMGame.Color.BLACK;let e=Math.floor(this.width/16);t.font=`italic ${e}px Times New Roman, serif`,t.fillText("U",this.canvas.width-1.5*e,1.25*e);for(let e of this.sprites)e.draw(t);for(let e of this.doodles)e.draw(t);this.ondraw(t),this.recordingVideo&&(this.screenVideoCtx.clearRect(game.canvas,0,0,this.screenVideoCanvas.width,this.screenVideoCanvas.height),this.screenVideoCtx.drawImage(game.canvas,this.screenVideoDetails.x,this.screenVideoDetails.y,this.screenVideoDetails.width,this.screenVideoDetails.height))}):"graphtheory"===this.type&&(this.vertices=[],this.edges=[],this.update=function(){this.onbeforeupdate(this.frameCount),this.frameCount++,this.frameCount>this.frameCap&&(this.frameCount=0);for(let t of this.edges)t.update();for(let t of this.vertices)t.update();for(let t of this.sprites)t.update();for(let t of this.doodles)t.update();this.onupdate(this.frameCount)},this.draw=function(t=this.offscreenCtx){t.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.onbeforedraw(t);for(let e of this.edges)e.draw(t);for(let e of this.vertices)e.draw(t);for(let e of this.sprites)e.draw(t);for(let e of this.doodles)e.draw(t);this.ondraw(t),this.recordingVideo&&(this.screenVideoCtx.clearRect(game.canvas,0,0,this.screenVideoCanvas.width,this.screenVideoCanvas.height),this.screenVideoCtx.drawImage(game.canvas,this.screenVideoDetails.x,this.screenVideoDetails.y,this.screenVideoDetails.width,this.screenVideoDetails.height))}),this.doodleOptions={},t.doodleOptions&&(this.doodleOptions=t.doodleOptions,void 0===t.doodleOptions.enabled&&(this.doodleOptions.enabled=!0)),this.doodles=[],this.currentDoodle=null,this.zoomLevel=1,this.unzoomedGraphScalar=this.graphScalar,this.unzoomedTickDistance=this.tickDistance,this.unzoomedOrigin=new CMPoint(this.origin.x,this.origin.y);let i=["onbeforestart","onstart","onbeforeupdate","onupdate","onbeforedraw","ondraw","ontouchstart","ontouchmove","ontouchend","onkeydown","onkeyup"];for(let s of i)"function"==typeof t[s]&&(this[s]=t[s].bind(e));"function"==typeof t.onload&&t.onload(),this.screenshotCanvas=null,this.screenshotCtx=null,this.screenVideoCanvas=null,this.screenVideoCtx=null,this.recordingVideo=!1,this.screenVideoDetails=null;let s=1920/this.width,n=1080/this.height;this.screenVideoDetails=s>n?{x:Math.max((1920-this.width*n)/2,0),y:Math.max((1080-this.height*n)/2,0),width:this.width*n,height:this.height*n}:{x:Math.max((1920-this.width*s)/2,0),y:Math.max((1080-this.height*s)/2,0),width:this.width*s,height:this.height*s},this.screenVideoCanvas||(this.screenVideoCanvas=document.createElement("canvas"),this.screenVideoCanvas.width=1920,this.screenVideoCanvas.height=1080,this.screenVideoCanvas.style.width="1920px",this.screenVideoCanvas.style.height="1080px",this.screenVideoCtx=this.screenVideoCanvas.getContext("2d",{alpha:!1})),this.alertOverlay=document.createElement("div"),this.alertOverlay.classList="cm-overlay cm-transparent-black",this.alertElement=document.createElement("aside"),this.alertElement.setAttribute("id","cmAlert");let a=document.createElement("header"),h=document.createElement("h3");this.alertMessage=document.createElement("p"),this.alertMessage.classList.add("cm-center-text");let o=document.createElement("p");o.classList.add("cm-center-text"),this.alertInput=document.createElement("input"),this.alertInput.type="text",this.alertInput.style.background="white",this.alertOKButton=document.createElement("button"),this.alertOKButton.className="cm-dark_green cm-text-white",this.alertOKButton.setAttribute("id","cmAlertOKBtn"),this.alertOKButton.innerText="OK",this.alertCancelButton=document.createElement("button"),this.alertCancelButton.className="cm-gray cm-text-white",this.alertCancelButton.setAttribute("id","cmAlertCancelBtn"),this.alertCancelButton.innerText="Cancel",this.alertOverlay.appendChild(this.alertElement),h.innerText=(document.title||"Game")+" says:",a.appendChild(h),this.alertElement.appendChild(a),this.alertElement.appendChild(this.alertMessage),o.appendChild(this.alertInput),o.appendChild(this.alertOKButton),o.appendChild(this.alertCancelButton),this.alertElement.appendChild(o),this.alertOverlay.style.display="none",documentBody.appendChild(this.alertOverlay)}rel(t){return"number"==typeof t?t/self.screenScalar:{x:t.x/self.screenScalar,y:t.y/self.screenScalar}}takeScreenshot(t={}){let e,i,s=this.canvas.toDataURL(),n=this,a=new Image,h={filename:t.filename||"cmgscreenshot.png",output:t.output||"download"};return new Promise(function(t,o){a.onload=function(){n.screenshotCanvas||(n.screenshotCanvas=document.createElement("canvas"),n.screenshotCtx=n.screenshotCanvas.getContext("2d")),n.screenshotCanvas.style.width=(n.screenshotCanvas.width=n.canvas.width)+"px",n.screenshotCanvas.style.height=(n.screenshotCanvas.height=n.canvas.height)+"px";let s=window.getComputedStyle(n.canvas),r=s.getPropertyValue("background-image");if(n.backgroundCanvas)n.screenshotCtx.drawImage(n.backgroundCanvas,0,0,n.screenshotCanvas.width,n.screenshotCanvas.height);else{if(r&&"none"!==r){let l=r.replace("url(","").replace(")",""),c=new Image;return c.onerror=function(t){o("Error loading background image source for screenshot")},c.onload=function(){let o=s.getPropertyValue("background-position-x")||0,r=s.getPropertyValue("background-position-y")||0,l=s.getPropertyValue("background-repeat-x")||"repeat",d=s.getPropertyValue("background-repeat-y")||"repeat",u=n.screenshotCanvas.width,m=n.screenshotCanvas.height,g=s.getPropertyValue("background-size").split(" ");g.length>1?(g[0].includes("px")&&(u=parseFloat(g[0].replace("px",""))),g[1].includes("px")&&(m=parseFloat(g[1].replace("px","")))):u=m=parseFloat(g[0].replace("px",""));for(let t=r;t<n.screenshotCanvas.height||"no-repeat"===d;t+=m)for(let e=o;e<n.screenshotCanvas.width||"no-repeat"===l;e+=u)n.screenshotCtx.drawImage(c,e,t,u,m);n.screenshotCtx.drawImage(a,0,0,n.screenshotCanvas.width,n.screenshotCanvas.height),i=n.screenshotCanvas.toDataURL(),n.screenshotLink.href=i,n.screenshotLink.download=h.filename,"download"===h.output&&n.screenshotLink.click(),(e=h.output instanceof HTMLImageElement?h.output:new Image).onload=(()=>{t({image:e,src:e.src})}),e.src=canvas.dataUrl},void(c.src=l)}n.screenshotCtx.fillStyle=s.getPropertyValue("background-color"),n.screenshotCtx.fillRect(0,0,n.screenshotCanvas.width,n.screenshotCanvas.height)}n.screenshotCtx.drawImage(a,0,0,n.screenshotCanvas.width,n.screenshotCanvas.height),i=n.screenshotCanvas.toDataURL(),n.screenshotLink.href=i,n.screenshotLink.download=h.filename,"download"===h.output&&n.screenshotLink.click(),(e=h.output instanceof HTMLImageElement?h.output:new Image).onload=(()=>{t({image:e,src:e.src})}),e.src=i},a.src=s})}takeScreenVideo(t={}){if(this.recordingVideo)return void console.error("Cannot record multiple videos simultaneously");let e,i,s=this,n={start:0,duration:5e3,fps:Math.round(CMGame.FPS),mimeType:"video/mp4",filename:"cmgscreenvideo.mp4",output:"download"};switch(typeof t){case"number":n.duration=t;break;case"object":for(let e in n)void 0!==t[e]&&(n[e]=t[e])}return"string"==typeof t.filename&&("string"==typeof t.mimeType?(i={"x-msvideo":".avi",mp4:".mp4",mpeg:".mpeg",ogg:".ogv",mp2t:".ts",webm:".webm","3gpp":".3gp","3gpp2":".3g2"}[e=t.mimeType.match(/video\/([a-z0-9\-]+)/)[0].replace("video/","")],t.filename.endsWith(i)||(console.warn('takeScreenVideo "filename" does not match "mimeType". Inferred extension will be appended to filename.'),n.filename=t.filename+i)):(e={avi:"x-msvideo",mp4:"mp4",mpeg:"mpeg",ogv:"ogg",ts:"mp2t",webm:"webm","3gp":"3gpp","3g2":"3gpp2"}[i=t.filename.substr(t.filename.lastIndexOf(".")+1)],n.mimeType="video/"+e)),new Promise(function(t,e){let i=s.screenVideoCanvas.captureStream(n.fps),a=[];s.videoRecorder=new MediaRecorder(i),s.videoRecorder.ondataavailable=function(t){t.data.size>0&&a.push(t.data)},s.videoRecorder.onstop=function(){let e=new Blob(a,{type:n.mimeType}),i=URL.createObjectURL(e),h={video:null,src:""};n.output instanceof HTMLVideoElement?(n.output.src=i,h.video=n.output,h.src=n.output.src):"download"===n.output&&(s.screenVideoLink.href=i,s.screenVideoLink.download=n.filename,h.video=null,h.src=s.screenVideoLink.href,s.screenVideoLink.click()),a=[],window.URL.revokeObjectURL(i),s.videoRecorder=null,t(h)},setTimeout(()=>{s.videoRecorder.onstart=(()=>{"indefinite"!==n.duration&&setTimeout(()=>{s.videoRecorder.stop(),s.recordingVideo=!1},n.duration)}),s.videoRecorder.start(),s.recordingVideo=!0},n.start)})}stopScreenVideo(){this.videoRecorder&&this.recordingVideo?(this.videoRecorder.stop(),this.recordingVideo=!1):console.warn("No video to stop")}start(){if(!this.started){"function"==typeof this.onbeforestart&&this.onbeforestart();for(let t of this.hideOnStart)"object"==typeof t?elm.style.display="none":"string"==typeof t&&(document.querySelector(t).style.display="none");return this.started=!0,this.animFrameId=requestNextFrame(this.runCycle),"function"==typeof this.onstart&&this.onstart(),this}}pause(){return this.paused=!0,cancelNextFrame(this.animFrameId),this.animFrameId=null,this}unpause(){let t=this;return this.paused&&(this.paused=!1,null===this.animFrameId&&(this.animFrameId=requestNextFrame(t.runCycle))),this}onbeforeupdate(t){}onupdate(t){}onbeforedraw(t){}ondraw(t){}onswipe(t){}ontouchstart(t){}ontouchmove(t){}ontouchend(t){}onmousedown(t){}onmousemove(t){}onmouseup(t){}onclick(t){}ondblclick(t){}onrightclick(t){}onpressstart(t){}onpressmove(t){}onpressend(t){}onkeydown(t){}onkeyup(t){}update(){this.onbeforeupdate(this.frameCount),this.frameCount++,this.frameCount>this.frameCap&&(this.frameCount=0);for(let t of this.functions)t.update(this.frameCount);for(let t of this.sprites)t.update(this.frameCount);this.onupdate(this.frameCount)}draw(t=this.offscreenCtx){if(t.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),this.onbeforedraw(t),this.gridStyle&&this.gridStyle!==CMGame.Color.TRANSPARENT){t.strokeStyle=this.gridStyle;for(let t=this.origin.x;t>0;t-=this.tickDistance)this.drawLine(t,0,t,this.offscreenCanvas.height);for(let t=this.origin.x;t<this.offscreenCanvas.width;t+=this.tickDistance)this.drawLine(t,0,t,this.offscreenCanvas.height);for(let t=this.origin.y;t>0;t-=this.tickDistance)this.drawLine(0,t,this.offscreenCanvas.width,t);for(let t=this.origin.y;t<this.offscreenCanvas.height;t+=this.tickDistance)this.drawLine(0,t,this.offscreenCanvas.width,t)}if(this.xAxisStyle&&this.xAxisStyle!==CMGame.Color.TRANSPARENT&&(t.strokeStyle=this.xAxisStyle,this.drawLine(0,this.origin.y,this.offscreenCanvas.width,this.origin.y)),this.yAxisStyle&&this.yAxisStyle!==CMGame.Color.TRANSPARENT&&(t.strokeStyle=this.yAxisStyle,this.drawLine(this.origin.x,0,this.origin.x,this.offscreenCanvas.height)),this.tickStyle&&this.tickStyle!==CMGame.Color.TRANSPARENT){t.strokeStyle=this.tickStyle;let e=Math.max(Math.min(5,.25*this.tickDistance),3);for(let t=this.origin.x-this.tickDistance;t>0;t-=this.tickDistance)this.drawLine(t,this.origin.y-e,t,this.origin.y+e);for(let t=this.origin.x+this.tickDistance;t<this.offscreenCanvas.width;t+=this.tickDistance)this.drawLine(t,this.origin.y-e,t,this.origin.y+e);for(let t=this.origin.y-this.tickDistance;t>0;t-=this.tickDistance)this.drawLine(this.origin.x-e,t,this.origin.x+e,t);for(let t=this.origin.y+this.tickDistance;t<this.offscreenCanvas.height;t+=this.tickDistance)this.drawLine(this.origin.x-e,t,this.origin.x+e,t)}for(let e of this.functions)e.draw(t);for(let e of this.sprites)e.draw(t);for(let e of this.doodles)e.draw(t);this.ondraw(t),this.recordingVideo&&(this.screenVideoCtx.clearRect(game.canvas,0,0,this.screenVideoCanvas.width,this.screenVideoCanvas.height),this.screenVideoCtx.drawImage(game.canvas,this.screenVideoDetails.x,this.screenVideoDetails.y,this.screenVideoDetails.width,this.screenVideoDetails.height))}startDoodle(t,e=this.doodleOptions){return this.doodleOptions.enabled=!0,e.startPoint=new CMPoint(t.x,t.y),this.currentDoodle=new CMDoodle(this,e),this.doodles.push(this.currentDoodle),this}stopDoodle(){return this.currentDoodle=null,this}clearDoodles(){return CMGame.clearAll(this.doodles),this.currentDoodle=null,!this.paused&&this.started||this.draw(),this}spriteFromDoodles(t,e=!1){let i,s=t||this.doodles;if(0===s.length)return null;let n=this.canvas.width,a=this.canvas.height,h=0,o=0;for(let t=0;t<s.length;t++)n=Math.min(n,Math.min.apply(Math,s[t].points.map(t=>t.x))),a=Math.min(a,Math.min.apply(Math,s[t].points.map(t=>t.y))),h=Math.max(h,Math.max.apply(Math,s[t].points.map(t=>t.x))),o=Math.max(o,Math.max.apply(Math,s[t].points.map(t=>t.y)));1===s[0].points.length&&s[0].addPoint(s[0].startPoint.x+.5,s[0].startPoint.y+.5);let r=new Path2D(s[0].path),l=1,c=[s[0].strokeStyle],d=[s[0].fillStyle],u=[s[0].lineWidth];for(let t=1;t<s.length;t++)1===s[t].points.length&&s[t].addPoint(s[t].startPoint.x+.5,s[t].startPoint.y+.5),r.addPath(s[t].path),l++,c.push(s[t].strokeStyle),d.push(s[t].fillStyle),u.push(s[t].lineWidth);return i=new CMGame.Sprite(this,n,a,h-n,o-a,function(t){t.save(),t.translate(this.x-n,this.y-a);for(let e=0;e<l;e++)t.fillStyle=d[e],t.fill(r),t.strokeStyle=c[e],t.lineWidth=u[e],t.stroke(r);t.restore()}),e||this.clearDoodles(),i}spriteFromDoodle(t,e=!1){let i=[];if(t)i=[t];else{if(!(game.doodles.length>0))return null;i=[CMGame.last(game.doodles)]}let s=this.spriteFromDoodles(i,!0);return e||-1===this.doodles.indexOf(i[0])||this.doodles.splice(this.doodles.indexOf(i[0]),1),s}addFunction(t){return t instanceof CMGame.Function&&this.functions.push(t),this}removeFunction(t){return t&&this.functions.splice(this.functions.indexOf(t),1),this}addSprite(t){return t&&(this.sprites.push(t),this.sprites.sort((t,e)=>t.layer-e.layer)),this}removeSprite(t){return t&&this.sprites.splice(this.sprites.indexOf(t),1),this}xToScreen(t){let e=this.graphScalar*t;return this.origin.x+e}xToReal(t){return(t-this.origin.x)/this.graphScalar}yToScreen(t){let e=this.graphScalar*t;return this.origin.y-e}yToReal(t){return-(t-this.origin.y)/this.graphScalar}toScreen(t){return{x:this.xToScreen(t.x),y:this.yToScreen(t.y)}}toReal(t){return{x:this.xToReal(t.x),y:this.yToReal(t.y)}}updateAndDraw(){this.update(),this.offscreenCtx.save(),this.offscreenCtx.scale(this.devicePixelRatio,this.devicePixelRatio),this.draw(this.offscreenCtx),this.offscreenCtx.restore(),this.moveOffscreenToScreen(),this.started&&!this.paused&&(this.animFrameId=requestNextFrame(this.runCycle))}moveOffscreenToScreen(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.offscreenCanvas,0,0,this.canvas.width,this.canvas.height)}resizeCanvas(){let t=this.canvasReferenceWidth,e=this.canvasReferenceHeight,i="width";document.documentElement.clientWidth<this.canvasReferenceWidth||document.documentElement.clientHeight<this.canvasReferenceHeight?("width"===(i=document.documentElement.clientWidth<this.canvasReferenceWidth&&document.documentElement.clientHeight<this.canvasReferenceHeight?document.documentElement.clientWidth/this.canvasReferenceWidth<document.documentElement.clientHeight/this.canvasReferenceHeight?"width":"height":document.documentElement.clientWidth<this.canvasReferenceWidth?"width":"height")?(t=Math.min.apply(Math,[document.documentElement.clientWidth,window.outerWidth,window.innerWidth,documentBody.clientWidth]),e=this.canvasReferenceHeight/this.canvasReferenceWidth*t,this.screenScalar=Math.min(t/this.canvasReferenceWidth,e/this.canvasReferenceHeight)):(e=Math.min.apply(Math,[document.documentElement.clientHeight,window.outerHeight,window.innerHeight,documentBody.clientHeight]),t=this.canvasReferenceWidth/this.canvasReferenceHeight*e,this.screenScalar=Math.min(t/this.canvasReferenceWidth,e/this.canvasReferenceHeight)),this.wrapper.style.transform="scale("+this.screenScalar+")",this.wrapper.style.left=`calc(100vw / 2 - ${.5*this.screenScalar} * ${this.width}px)`,this.wrapper.style.top="0"):(t=this.canvasReferenceWidth,e=this.canvasReferenceHeight,this.wrapper.style.width=(this.wrapper.width=t)+"px",this.wrapper.style.height=(this.wrapper.height=e)+"px",this.screenScalar=1,this.wrapper.style.transform="scale("+this.screenScalar+")",this.wrapper.style.left=`calc(100vw / 2 - ${.5*this.screenScalar} * ${this.width}px)`,this.wrapper.style.top="18px")}generateSaveName(){let t=0;for(;null!==localStorage.getItem(CMGame.SAVE_PREFIX+t);)t++;return CMGame.SAVE_PREFIX+t}save(t,e){let i="",s={};switch(typeof t){case"string":i=t,s="object"==typeof e?e:this.state;break;case"object":s=t,i=this.saveName;break;default:i=this.saveName,s=this.state}try{localStorage.setItem(i,JSON.stringify(s)),console.log("Saving game data under name: %c"+i,"font-weight: bold; font-size: large; color: white; background-color: rgb(1, 97, 251); display: inline-block; border-radius: 4px; padding: 3px 5px;")}catch(t){console.error("Error thrown during localStorage save. Possible security issue, e.g., when testing save on local directory.")}}load(t){let e=null,i="";"string"==typeof t?i=t:this.saveName?i=this.saveName:"0"!==(i=this.generateSaveName()).replace(CMGame.SAVE_PREFIX,"")&&(i=CMGame.SAVE_PREFIX+(parseInt(i.replace(CMGame.SAVE_PREFIX,""))-1));try{e=localStorage.getItem(i),console.log("Loading game data saved under name: %c"+i,"font-weight: bold; font-size: large; color: white; background-color: rgb(1, 97, 251); display: inline-block; border-radius: 4px; padding: 3px 5px;")}catch(t){console.error("Error thrown during localStorage load. Possible security issue, e.g., when testing save on local directory.")}return null!==e?(this.state=JSON.parse(e),this.state):{}}keyDown(t){switch(game.paused||t.preventDefault(),t.keyCode){case 38:case 87:case 104+1e3*+!this.ignoreNumLock:t.direction="up";break;case 40:case 83:case 98+1e3*+!this.ignoreNumLock:t.direction="down";break;case 37:case 65:case 100+1e3*+!this.ignoreNumLock:t.direction="left";break;case 39:case 68:case 102+1e3*+!this.ignoreNumLock:t.direction="right";break;default:t.direction=""}this.onkeydown(t)}keyUp(t){switch(t.preventDefault(),t.keyCode){case 38:case 87:case 104+1e3*+!this.ignoreNumLock:t.direction="up";break;case 40:case 83:case 98+1e3*+!this.ignoreNumLock:t.direction="down";break;case 37:case 65:case 100+1e3*+!this.ignoreNumLock:t.direction="left";break;case 39:case 68:case 102+1e3*+!this.ignoreNumLock:t.direction="right";break;default:t.direction=""}this.onkeyup(t)}click(t){t.preventDefault(),this.onclick(t)}dblClick(t){t.preventDefault(),this.ondblclick(t)}touchStart(t){if(this.passiveFlag||t.preventDefault(),this.numPressPoints=t.touches.length,this.ontouchstart(t),this.multiTouch)for(let e=0;e<t.targetTouches.length;e++)this.pressStart((t.targetTouches[e].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.targetTouches[e].clientY-this.wrapper.offsetTop)/this.screenScalar);else this.pressStart((t.targetTouches[0].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.targetTouches[0].clientY-this.wrapper.offsetTop)/this.screenScalar)}mouseDown(t){switch(t.preventDefault(),this.leftMousePressed=!1,this.middleMousePressed=!1,this.rightMousePressed=!1,t.buttons){case 0:this.numPressPoints=0;break;case 1:this.leftMousePressed=!0,this.numPressPoints=1;break;case 2:this.rightMousePressed=!0,this.numPressPoints=1;break;case 3:this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 4:this.middleMousePressed=!0,this.numPressPoints=1;break;case 5:this.middleMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 6:this.middleMousePressed=!0,this.rightMousePressed=!0,this.numPressPoints=1;break;case 7:this.middleMousePressed=!0,this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=3;break;default:this.numPressPoints=0}this.numPressPoints=this.toBinary(t.buttons).split("").reduce((t,e)=>t+ +e,0),this.mouseState=[0,+this.leftMousePressed,+this.middleMousePressed,+this.rightMousePressed,0],this.mouseStateString=this.mouseState.join(""),this.onmousedown(t),this.pressStart((t.clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.clientY-this.wrapper.offsetTop)/this.screenScalar),2===t.button&&this.onrightclick(t)}pressStart(t,e){null===this.latestPoint&&(this.latestPoint={x:t,y:e}),this.doodleOptions.enabled&&this.startDoodle(new CMPoint(t,e),this.doodleOptions),this.onpressstart({x:t,y:e})}touchMove(t){if(this.passiveFlag||t.preventDefault(),this.numPressPoints=t.touches.length,this.ontouchmove(t),this.multiTouch)for(let e=0;e<t.targetTouches.length;e++)this.pressMove((t.targetTouches[e].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.targetTouches[e].clientY-this.wrapper.offsetTop)/this.screenScalar);else this.pressMove((t.targetTouches[0].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.targetTouches[0].clientY-this.wrapper.offsetTop)/this.screenScalar)}mouseMove(t){switch(t.preventDefault(),this.leftMousePressed=!1,this.middleMousePressed=!1,this.rightMousePressed=!1,t.buttons){case 0:this.numPressPoints=0;break;case 1:this.leftMousePressed=!0,this.numPressPoints=1;break;case 2:this.rightMousePressed=!0,this.numPressPoints=1;break;case 3:this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 4:this.middleMousePressed=!0,this.numPressPoints=1;break;case 5:this.middleMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 6:this.middleMousePressed=!0,this.rightMousePressed=!0,this.numPressPoints=2;break;case 7:this.middleMousePressed=!0,this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=3;break;default:this.numPressPoints=0}this.numPressPoints=this.toBinary(t.buttons).split("").reduce((t,e)=>t+ +e,0),this.mouseState=[0,+this.leftMousePressed,+this.middleMousePressed,+this.rightMousePressed,0],this.mouseStateString=this.mouseState.join(""),this.onmousemove(t),this.leftMousePressed&&this.pressMove((t.clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.clientY-this.wrapper.offsetTop)/this.screenScalar)}pressMove(t,e){let i=t,s=e;null===this.latestPoint?this.latestPoint={x:t,y:e}:this.distance(this.latestPoint,new CMPoint(t,e))>=CMGame.PIXELS_FOR_SWIPE&&(this.onswipe(new CMSwipe(this,t,e,this.latestPoint.x,this.latestPoint.y)),i=this.latestPoint.x,s=this.latestPoint.y,this.latestPoint={x:t,y:e}),this.currentDoodle&&this.currentDoodle.addPoint(t,e),this.onpressmove({x:t,y:e,oldX:i,oldY:s,offset:{x:t-i,y:e-s}})}touchEnd(t){if(t.preventDefault(),this.numPressPoints=t.touches.length,this.multiTouch)for(let e=0;e<t.changedTouches.length;e++)this.pressEnd((t.changedTouches[e].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.changedTouches[e].clientY-this.wrapper.offsetTop)/this.screenScalar);else this.pressEnd((t.changedTouches[0].clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.changedTouches[0].clientY-this.wrapper.offsetTop)/this.screenScalar)}mouseUp(t){switch(t.preventDefault(),this.leftMousePressed=!1,this.middleMousePressed=!1,this.rightMousePressed=!1,this.numPressPoints=0,t.buttons){case 0:this.numPressPoints=0;break;case 1:this.leftMousePressed=!0,this.numPressPoints=1;break;case 2:this.rightMousePressed=!0,this.numPressPoints=1;break;case 3:this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 4:this.middleMousePressed=!0,this.numPressPoints=1;break;case 5:this.middleMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=2;break;case 6:this.middleMousePressed=!0,this.rightMousePressed=!0,this.numPressPoints=2;break;case 7:this.middleMousePressed=!0,this.rightMousePressed=!0,this.leftMousePressed=!0,this.numPressPoints=3;break;default:this.numPressPoints=0}this.numPressPoints=this.toBinary(t.buttons).split("").reduce((t,e)=>t+ +e,0),this.mouseState=[0,+this.leftMousePressed,+this.middleMousePressed,+this.rightMousePressed,0],this.mouseStateString=this.mouseState.join(""),this.onmouseup(t),this.pressEnd((t.clientX-this.wrapper.offsetLeft)/this.screenScalar,(t.clientY-this.wrapper.offsetTop)/this.screenScalar)}pressEnd(t,e){this.latestPoint=null,CMGame.clearAll(this.latestSwipes,this.latestSwipeStrings,this.latestSwipeStrings8,this.latestSwipePath,this.latestSwipePath8),this.currentDoodle&&this.stopDoodle(),this.onpressend({x:t,y:e})}areColliding(t,e,i,s,n,a,h,o){if(void 0!==s)return t<=n+h&&t+i>=n&&e<=a+o&&e+s>=a;let r=t,l=e;if(r.shape||(r.shape="rect"),l.shape||(l.shape="rect"),"circle"===r.shape){if("circle"===l.shape)return this.distance(r,l)<=r.radius+l.radius;if("rect"===l.shape)return this.areColliding(r.x-r.radius,r.y-r.radius,2*r.radius,2*r.radius,l.x,l.y,l.width,l.height)}return"circle"===l.shape&&"rect"===r.shape?this.areColliding(r.x,r.y,r.width,r.height,l.x-l.radius,l.y-l.radius,2*l.radius,2*l.radius):r.x<=l.x+l.width&&r.x+r.width>=l.x&&r.y<=l.y+l.height&&r.y+r.height>=l.y}distance(t,e){return void 0!==t.z&&void 0!==e.z?Math.hypot(t.x-e.x,t.y-e.y,t.z-e.z):Math.hypot(t.x-e.x,t.y-e.y)}drawLine(t,e,i,s){return void 0!==i?(this.offscreenCtx.beginPath(),this.offscreenCtx.moveTo(t,e),this.offscreenCtx.lineTo(i,s),this.offscreenCtx.stroke(),this):(this.offscreenCtx.beginPath(),this.offscreenCtx.moveTo(t.x,t.y),this.offscreenCtx.lineTo(e.x,e.y),this.offscreenCtx.stroke(),this)}fillOval(t,e,i,s){this.offscreenCtx.beginPath(),void 0!==s?this.offscreenCtx.ellipse(t+.5*i,e+.5*s,.5*i,.5*s,0,0,Math.TAU,!1):this.offscreenCtx.arc(t,e,i,0,Math.TAU,!1),this.offscreenCtx.fill()}strokeOval(t,e,i,s){this.offscreenCtx.beginPath(),void 0!==s?this.offscreenCtx.ellipse(t+.5*i,e+.5*s,.5*i,.5*s,0,0,Math.TAU,!1):this.offscreenCtx.arc(t,e,i,0,Math.TAU,!1),this.offscreenCtx.stroke()}fillRoundedRect(t,e,i,s,n){i<2*n&&(n=.5*i),s<2*n&&(n=.5*s),this.offscreenCtx.beginPath(),this.offscreenCtx.moveTo(t+n,e),this.offscreenCtx.arcTo(t+i,e,t+i,e+s,n),this.offscreenCtx.arcTo(t+i,e+s,t,e+s,n),this.offscreenCtx.arcTo(t,e+s,t,e,n),this.offscreenCtx.arcTo(t,e,t+i,e,n),this.offscreenCtx.closePath(),this.offscreenCtx.fill()}strokeRoundedRect(t,e,i,s,n){i<2*n&&(n=.5*i),s<2*n&&(n=.5*s),this.offscreenCtx.beginPath(),this.offscreenCtx.moveTo(t+n,e),this.offscreenCtx.arcTo(t+i,e,t+i,e+s,n),this.offscreenCtx.arcTo(t+i,e+s,t,e+s,n),this.offscreenCtx.arcTo(t,e+s,t,e,n),this.offscreenCtx.arcTo(t,e,t+i,e,n),this.offscreenCtx.closePath(),this.offscreenCtx.stroke()}circleIntersectsRect(t,e){let i=Math.abs(t.x-e.x),s=Math.abs(t.y-e.y);return!(i>.5*e.width+t.radius)&&(!(s>.5*e.height+t.radius)&&(i<=.5*e.width||(s<=.5*e.height||(i-.5*e.width)**2+(s-.5*e.height)**2<=t.r**2)))}drawRotatedImage(t,...e){let i=e.length,s=e[i-1],n=0;switch(typeof s){case"number":n=s;break;case"object":n=s.angle;break;default:n=0}let a=e[0],h=e[1],o=e[2]||t.width,r=e[3]||t.height;i>5&&(a=e[0],h=e[1],o=e[2]||t.width,r=e[3]||t.height);let l={x:a+.5*o,y:h+.5*r};this.offscreenCtx.save(),this.offscreenCtx.translate(l.x,l.y),this.offscreenCtx.rotate(n),this.offscreenCtx.translate(-l.x,-l.y),this.offscreenCtx.drawImage.apply(this.offscreenCtx,[t,...e]),this.offscreenCtx.restore()}drawStrings(t,e,i,s,n={}){let a,h={fill:!0,stroke:!1,fillStyles:[],strokeStyles:[]},o={};for(let t in h)o[t]=void 0!==n[t]?n[t]:h[t];if(Array.isArray(t)&&Array.isArray(t[0])){let a=i;for(let a=0,h=Math.max(t.length,e.length);a<h;a++){let h=10,r=15,l={fill:Array.isArray(o.fill)?o.fill[a]:o.fill,stroke:Array.isArray(o.stroke)?o.stroke[a]:o.stroke,fillStyles:[[]],strokeStyles:[[]]};if(Array.isArray(n.fillStyles)&&Array.isArray(n.fillStyles[0])&&(l.fillStyles=n.fillStyles[a]),Array.isArray(n.strokeStyles)&&Array.isArray(n.strokeStyles[0])&&(l.strokeStyles=n.strokeStyles[a]),"number"==typeof n.lineHeight)r=n.lineHeight;else for(let e=0,i=t.length;e<i;e++){let i=t[a][e].match(/[0-9]+[A-Za-z]+/,"");i&&(r=1.5*(h=Math.max(h,parseInt(i[0]))))}this.drawStrings(t[a],e[a].concat([a]),i,s+a*r,l)}return a}"string"==typeof o.fillStyles?o.fillStyles=[o.fillStyles]:o.fillStyles&&0!==o.fillStyles.length||(o.fillStyles=[this.offscreenCtx.fillStyle]),"string"==typeof o.strokeStyles?o.strokeStyles=[o.strokeStyles]:o.strokeStyles&&0!==o.strokeStyles.length||(o.strokeStyles=[this.offscreenCtx.strokeStyle]),void 0!==o.colors&&console.warn('"colors" is not a valid option for drawStrings(). Use "fillStyles" or "strokeStyles" instead.'),"string"==typeof t&&(t=[t]),"string"==typeof e&&(e=[e]),t&&0!==t.length||(t=[this.offscreenCtx.font]),a=t.length;let r=e.length,l=0;for(let n=0;n<r;n++)this.offscreenCtx.font=t[n%a],o.fill&&(this.offscreenCtx.fillStyle=o.fillStyles[n%o.fillStyles.length],this.offscreenCtx.fillText(e[n],i+l,s)),o.stroke&&(this.offscreenCtx.strokeStyle=o.strokeStyles[n%o.strokeStyles.length],this.offscreenCtx.strokeText(e[n],i+l,s)),l+=this.offscreenCtx.measureText(e[n]).width;return i+l}measureStrings(t,e){"string"==typeof t?t=[t]:t&&0!==t.length||(t=[this.offscreenCtx.font]),"string"==typeof e&&(e=[e]);let i=t.length,s=e.length,n=0;for(let a=0;a<s;a++)this.offscreenCtx.font=t[a%i],n+=this.offscreenCtx.measureText(e[a]).width;return n}drawStringsCentered(t,e,i,s,n={}){let a={fill:!0,stroke:!1,fillStyles:[],strokeStyles:[],angle:0,centerVertically:!0},h={};for(let t in a)h[t]=void 0!==n[t]?n[t]:a[t];let o=t,r=0;"string"==typeof t&&(o=[t]),t&&0!==t.length||(o=[this.offscreenCtx.font]);let l=Array.isArray(e)?e:[e];"string"==typeof h.fillStyles?h.fillStyles=[h.fillStyles]:h.fillStyles&&0!==h.fillStyles.length||(h.fillStyles=[this.offscreenCtx.fillStyle]),"string"==typeof h.strokeStyles?h.strokeStyles=[h.strokeStyles]:h.strokeStyles&&0!==h.strokeStyles.length||(h.strokeStyles=[this.offscreenCtx.strokeStyle]),r=o.length;let c=l.length,d=0;this.offscreenCtx.save(),h.centerVertically&&(this.offscreenCtx.textBaseline="middle");let u=this.measureStrings.apply(this,[o,l]),m=i-.5*u;0!==h.angle&&(this.offscreenCtx.translate(i,s),this.offscreenCtx.rotate(h.angle),this.offscreenCtx.translate(-i,-s));for(let t=0;t<c;t++)this.offscreenCtx.font=o[t%r],h.fill&&(this.offscreenCtx.fillStyle=h.fillStyles[t%h.fillStyles.length],this.offscreenCtx.fillText(l[t],m+d,s)),h.stroke&&(this.offscreenCtx.strokeStyle=h.strokeStyles[t%h.strokeStyles.length],this.offscreenCtx.strokeText(l[t],m+d,s)),d+=this.offscreenCtx.measureText(l[t]).width;return this.offscreenCtx.restore(),new CMPoint(i+.5*u*Math.cos(h.angle),s+.5*u*Math.sin(h.angle))}playSound(t){if(!this.soundOn)return;let e=this;CMSound.play(t).then(CMGame.noop,function(){try{e.audioMap.get(t).play()}catch(e){console.error(`Error playing sound ${t}.\n\t\t\t\t\tCheck that all files are loaded.`)}})}stopSound(t){let e=this;CMSound.stop(t).then(CMGame.noop,()=>{try{e.audioMap.get(t).pause(),e.audioMap.get(t).currentTime=0}catch(e){console.error("Error pausing sound "+t)}})}pauseSound(t){let e=this;CMSound.stop(t).then(CMGame.noop,()=>{try{e.audioMap.get(t).pause(),e.audioMap.get(t).currentTime=0}catch(e){console.error("Error pausing sound "+t)}})}playMusic(t){if(!this.musicOn)return;let e=this;CMSound.loop(t).then(CMGame.noop,()=>{try{e.audioMap.get(t).loop=!0,e.audioMap.get(t).play()}catch(e){console.error(`Error playing sound ${t}.\n\t\t\t\t\tCheck that all files are loaded.`)}})}pauseMusic(t){let e=this;CMSound.pause(t).then(CMGame.noop,()=>{try{e.audioMap.get(t).pause()}catch(e){console.error("Error pausing sound "+t)}})}stopMusic(t){let e=this;CMSound.stop(t).then(CMGame.noop,()=>{try{e.audioMap.get(t).pause(),e.audioMap.get(t).currentTime=0}catch(e){console.error("Error pausing sound "+t)}})}zoom(t){if("number"!=typeof t||t<=0||!Number.isFinite(t)||Number.isNaN(t))return console.error("zoom() must take a positive integer or float value as its argument. Set to 1 for 100%."),this;this.zoomLevel=t,this.graphScalar=this.unzoomedGraphScalar/this.zoomLevel,this.tickDistance=this.unzoomedTickDistance/this.zoomLevel,1===this.zoomLevel?(this.origin.x=this.unzoomedOrigin.x,this.origin.y=this.unzoomedOrigin.y):(this.origin.x=this.center.x+(this.unzoomedOrigin.x-this.center.x)/this.zoomLevel,this.origin.y=this.center.y+(this.unzoomedOrigin.y-this.center.y)/this.zoomLevel);for(let t of this.functions)t.updateBoundsOnResize(this.zoomLevel);return this.paused&&this.draw(),this}toDegrees(t){return 180*t/Math.PI}toRadians(t){return Math.PI*t/180}toPolar(t,e){let i,s;if("number"==typeof e?(i=t,s=e):(i=t.x,s=t.y),0===i)return s>0?{r:s,theta:Math.PI/2}:s<0?{r:s,theta:3*Math.PI/2}:{r:0,theta:0};let n=Math.atan(s/i);return i<0?n+=Math.PI:s<0&&(n+=2*Math.PI),{r:Math.hypot(i,s),theta:n}}roundSmall(t){return Math.abs(t)<Number.EPSILON?0:t}fromPolar(t,e){return"number"==typeof e?{x:this.roundSmall(t*Math.cos(e)),y:this.roundSmall(t*Math.sin(e))}:{x:this.roundSmall(t.r*Math.cos(t.theta)),y:this.roundSmall(t.r*Math.sin(t.theta))}}slopeToDegrees(t){return t===1/0?90:t===-1/0?270:this.toDegrees(this.slopeToRadians(t))}slopeToRadians(t){return t===1/0?.5*Math.PI:t===-1/0?1.5*Math.PI:this.toPolar({x:1,y:t}).theta}degreesToSlope(t){for(;t>=360;)t-=360;for(;t<0;)t+=360;return 90===t?1/0:270===t?-1/0:Math.tan(this.toPolar(t))}radiansToSlope(t){for(;t>=Math.TAU;)t-=Math.TAU;for(;t<0;)t+=Math.TAU;return t===Math.PI/2?1/0:t===3*Math.PI/2?-1/0:Math.tan(t)}getSlope(t,e){return(e.y-t.y)/(e.x-t.x)}getFiniteSlope(t,e){let i=(e.y-t.y)/(e.x-t.x);return Number.isFinite(i)?i:void 0}toBinary(t){return(t>>>0).toString(2)}fromBinary(t){return parseInt(t,2)}setNumberOfSets(t,e=0){this.numSets=t,this.vennSets.clear(),this.vennRegions.clear();let i=Math.floor(this.width/16);switch(this.ctx.save(),this.ctx.font=`italic ${i}px Times New Roman, serif`,t){case 0:default:this.vennRegions.set("I",new VennRegion(this,"",0));break;case 1:this.vennRegions.set("I",new VennRegion(this,"0",0)),this.vennRegions.set("II",new VennRegion(this,"1",0)),this.vennSets.set("A",new VennSet(this,320,240,168,{text:"A",x:446,y:408}));break;case 2:1===e?(this.vennRegions.set("I",new VennRegion(this,"0S0",1)),this.vennRegions.set("II",new VennRegion(this,"0S1",1)),this.vennRegions.set("III",new VennRegion(this,"1S1",1)),this.vennSets.set("A",new VennSet(this,320,288,108,{text:"A",x:390.2,y:390.6})),this.vennSets.set("B",new VennSet(this,320,240,192,{text:"B",x:444.8,y:412.8}))):(this.vennRegions.set("I",new VennRegion(this,"00",0)),this.vennRegions.set("II",new VennRegion(this,"10",0)),this.vennRegions.set("III",new VennRegion(this,"01",0)),this.vennRegions.set("IV",new VennRegion(this,"11",0)),this.vennSets.set("A",new VennSet(this,240,240,168,{text:"A",x:114-this.ctx.measureText("A").width,y:408})),this.vennSets.set("B",new VennSet(this,400,240,168,{text:"B",x:526,y:408})));break;case 3:1===e?(this.vennRegions.set("I",new VennRegion(this,"0S0S0",1)),this.vennRegions.set("II",new VennRegion(this,"0S0S1",1)),this.vennRegions.set("III",new VennRegion(this,"0S1S1",1)),this.vennRegions.set("IV",new VennRegion(this,"1S1S1",1)),this.vennSets.set("A",new VennSet(this,320,292,80,{text:"A",x:368,y:372})),this.vennSets.set("B",new VennSet(this,320,268,135,{text:"B",x:428,y:369.25})),this.vennSets.set("C",new VennSet(this,320,240,192,{text:"C",x:492.8,y:345.6}))):2===e?(this.vennRegions.set("I",new VennRegion(this,"000",2)),this.vennRegions.set("II",new VennRegion(this,"100",2)),this.vennRegions.set("III",new VennRegion(this,"010",2)),this.vennRegions.set("IV",new VennRegion(this,"001",2)),this.vennRegions.set("V",new VennRegion(this,"110",2)),this.vennRegions.set("VI",new VennRegion(this,"101",2)),this.vennRegions.set("VII",new VennRegion(this,"011",2)),this.vennRegions.set("VIII",new VennRegion(this,"111",2)),this.vennSets.set("A",new VennSet(this,256,168,144,{text:"A",x:256-.775*144-this.ctx.measureText("A").width,y:60})),this.vennSets.set("B",new VennSet(this,384,168,144,{text:"B",x:495.6,y:60})),this.vennSets.set("C",new VennSet(this,320,300,144,{text:"C",x:406.4,y:429.6}))):(this.vennRegions.set("I",new VennRegion(this,"000",0)),this.vennRegions.set("II",new VennRegion(this,"100",0)),this.vennRegions.set("III",new VennRegion(this,"010",0)),this.vennRegions.set("IV",new VennRegion(this,"001",0)),this.vennRegions.set("V",new VennRegion(this,"110",0)),this.vennRegions.set("VI",new VennRegion(this,"101",0)),this.vennRegions.set("VII",new VennRegion(this,"011",0)),this.vennRegions.set("VIII",new VennRegion(this,"111",0)),this.vennSets.set("A",new VennSet(this,256,300,144,{text:"A",x:148-this.ctx.measureText("A").width,y:444})),this.vennSets.set("B",new VennSet(this,384,300,144,{text:"B",x:492,y:444})),this.vennSets.set("C",new VennSet(this,320,168,144,{text:"C",x:428,y:60})))}this.ctx.restore()}addEdge(t){return t&&this.edges.push(t),this}addVertex(t){return t&&this.vertices.push(t),this}removeEdge(t){return t&&this.edges.splice(this.edges.indexOf(t),1),this}removeVertex(t){return t&&this.vertices.splice(this.vertices.indexOf(t),1),this}alert(t=""){let e=this,i=this.paused;i||this.pause();let s=this.doodleOptions.enabled;return s&&(this.doodleOptions.enabled=!1),this.alertMessage.innerHTML=t,this.alertCancelButton.style.display="none",this.alertInput.style.display="none",new Promise(function(t,n){e.alertOKButton.onclick=function(n){n.preventDefault(),e.alertOverlay.style.display="none",i||e.unpause(),s&&(this.doodleOptions.enabled=!0),t()},e.alertOverlay.style.display="block"})}confirm(t=""){let e=this,i=this.paused;i||this.pause();let s=this.doodleOptions.enabled;return s&&(this.doodleOptions.enabled=!1),this.alertMessage.innerHTML=t,this.alertCancelButton.style.display="inline-block",this.alertInput.style.display="none",new Promise(function(t,n){e.alertOKButton.onclick=function(n){n.preventDefault(),e.alertOverlay.style.display="none",i||e.unpause(),s&&(this.doodleOptions.enabled=!0),t(!0)},e.alertCancelButton.onclick=function(n){n.preventDefault(),e.alertOverlay.style.display="none",i||e.unpause(),s&&(this.doodleOptions.enabled=!0),t(!1)},e.alertOverlay.style.display="block"})}prompt(t="",e=""){let i=this,s=this.paused;s||this.pause();let n=this.doodleOptions.enabled;return n&&(this.doodleOptions.enabled=!1),this.alertMessage.innerHTML=t,this.alertInput.value=e,this.alertInput.style.display="inline-block",this.alertCancelButton.style.display="inline-block",new Promise(function(t,e){i.alertOKButton.onclick=function(e){e.preventDefault(),i.alertOverlay.style.display="none",s||i.unpause(),n&&(this.doodleOptions.enabled=!0),t(i.alertInput.value)},i.alertCancelButton.style.display="inline-block",i.alertCancelButton.onclick=function(e){e.preventDefault(),i.alertOverlay.style.display="none",s||i.unpause(),n&&(this.doodleOptions.enabled=!0),t(null)},i.alertOverlay.style.display="block"})}enterFullscreen(t){let e,i=document.documentElement;if(i.requestFullscreen?i.requestFullscreen():i.msRequestFullscreen?i.msRequestFullscreen():i.mozRequestFullScreen?i.mozRequestFullScreen():i.webkitRequestFullscreen&&i.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT),t)try{e=window.screen.orientation?this.orientationLock.call(window.screen.orientation,t||"landscape"):this.orientationLock.call(window.screen,t||"landscape")}catch(t){console.warn("Cannot lock orientation on this device")}}exitFullscreen(){document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen()}}CMGame.clearAll=function(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)CMGame.clearAll(arguments[t]);return Array.from(arguments)}if(Array.isArray(t))t.splice(0,t.length);else if(t instanceof Map)t.clear();else for(let e in t)t.hasOwnProperty(e)&&delete t[e];return t},CMGame.pickFrom=(t=>{if(Array.isArray(t))return t[CMRandom.range(0,t.length)];if(t instanceof Map){let e=[];for(let[i,s]of t)e.push(s);return e[CMRandom.range(0,e.length)]}{let e=Object.values(t);return e[CMRandom.range(0,e.length)]}}),CMGame.pluckFrom=(t=>{if(Array.isArray(t))return t.splice(CMRandom.range(0,t.length),1);if(t instanceof Map){let e=[];for(let[i,s]of t)e.push(s);let i=e[CMRandom.range(0,e.length)];return t.delete(i),i}{let e=Object.keys(t),i=e[CMRandom.range(0,e.length)],s=t[i];return delete t[i],s}}),CMGame.shuffle=(t=>{let e=[];for(let i=0;i<t.length;i++)e.push(t[i]);for(t=CMGame.clearAll(t);e.length>0;)t.push(CMGame.pluckFrom(e));return t}),CMGame.last=(t=>{let e=Array.from(t);return e[e.length-1]}),CMGame.isPrimitiveSubArray=((t,e)=>{return e.join("{(*&$(*(").includes(t.join("{(*&$(*("))}),CMGame.noop=(()=>{}),CMGame.trimFilename=(t=>{let e=t.substr(0,t.lastIndexOf("."));return e.substr(e.lastIndexOf("/")+1)}),CMGame.onpageload=CMGame.noop,CMGame.pageLoaded=!1,CMGame.onresourcesload=CMGame.noop,CMGame.resourcesLoaded=!1,CMGame.manageLoad=(t=>{if(!CMGame.pageLoaded){if(document.querySelectorAll("body").length>1){document.querySelectorAll("body").forEach(t=>{t!==document.body&&t.parentNode.removeChild(t)})}CMGame.pageLoaded=!0,CMGame.onpageload.call(window,t),domLoaded=!0,initializeIfReady()}}),window.addEventListener("pageshow",CMGame.manageLoad,!1),window.addEventListener("load",CMGame.manageLoad,!1),document.addEventListener("readystatechange",()=>{"complete"===document.readyState&&CMGame.manageLoad.call(window)},!1),CMGame.PIXELS_FOR_SWIPE=5,CMGame.SAVE_PREFIX="cmgamesave_",function(){Object.defineProperty(CMGame,"MAX_FPS",{value:60,writable:!1}),Object.defineProperty(CMGame,"MIN_FRAME_DELAY",{value:16.7,writable:!1});let t=CMGame.MAX_FPS,e=CMGame.MIN_FRAME_DELAY,i=null;Object.defineProperty(CMGame,"FPS",{get:()=>t,set(e){t=Math.min(e,CMGame.MAX_FPS),CMGame.FRAME_DELAY!==1e3/e&&(CMGame.FRAME_DELAY=1e3/e)}}),Object.defineProperty(CMGame,"FRAME_DELAY",{get:()=>e,set(t){(e=Math.max(t,CMGame.MIN_FRAME_DELAY))===CMGame.MIN_FRAME_DELAY?(window.requestNextFrame=window.requestAnimationFrame,window.cancelNextFrame=window.cancelAnimationFrame):(window.requestNextFrame=function(e){setTimeout(function(){i=requestAnimationFrame(e)},t)},window.cancelNextFrame=function(){cancelAnimationFrame(i)})}})}(),CMGame.Color={FUSCHIA:"rgb(253, 13, 136)",MAGENTA:"rgb(228, 0, 228)",PINK:"rgb(254, 3, 133)",RED:"rgb(250, 0, 92)",DARK_RED:"rgb(133, 33, 33)",ORANGE:"rgb(254, 137, 39)",YELLOW:"rgb(255, 245, 10)",GOLD:"rgb(255, 193, 4)",LIGHT_GREEN:"rgb(0, 240, 0)",GREEN:"rgb(0, 185, 0)",DARK_GREEN:"rgb(0, 136, 0)",SKY_BLUE:"rgb(142, 227, 252)",LIGHT_BLUE:"rgb(0, 250, 235)",BLUE:"rgb(1, 97, 251)",BLUE_GREEN:"rgb(0, 168, 153)",VIOLET:"rgb(185, 51, 158)",PURPLE:"rgb(128, 0, 128)",BROWN:"rgb(121, 74, 25)",SAND:"rgb(242, 245, 235)",TAN:"rgb(242, 228, 205)",PEACH:"rgb(242, 222, 212)",WHITE:"rgb(255, 255, 255)",ALMOST_WHITE:"rgb(250, 250, 250)",BLACK:"rgb(0, 0, 0)",ALMOST_BLACK:"rgb(15, 23, 33)",GRAY:"rgb(158, 158, 158)",LIGHT_GRAY:"rgb(205, 205, 205)",DARK_GRAY:"rgb(58, 58, 58)",TRANSLUCENT_WHITE:"rgba(255, 255, 255, 0.85)",TRANSLUCENT_BLACK:"rgba(0, 0, 0, 0.85)",TRANSPARENT:"rgba(0, 0, 0, 0)"},Object.defineProperty(CMGame.prototype,"font",{get(){let t=this,e=this.offscreenCtx.font.match(/[0-9]+[A-Za-z]+/,"");return{rel:e=>e/t.screenScalar,MONO:`${e=e?e[0]:"10px"} monospace`,SANS_SERIF:`${e} OpenSans, Arial, sans-serif`,SERIF:`${e} Times New Roman, serif`,VARIABLE:`italic ${e} Times New Roman, serif`}}}),function(){let t=20;Object.defineProperty(CMGame.prototype,"graphScalar",{get:()=>t,set(e){let i=t;t=e;for(let t of this.functions)t.updateBoundsOnResize(i)}})}(),CMGame.toastElement||(CMGame.toastElement=document.createElement("span"),CMGame.toastElement.setAttribute("id","cmToast"),CMGame.toastElement.classList.add("cm-toast"),documentBody.appendChild(CMGame.toastElement),CMGame.toastElement.addEventListener("animationend",function(){CMGame.toastElement.style.display="none"},!1),CMGame.toastElement.addEventListener("animationcancel",function(){CMGame.toastElement.style.display="none"},!1)),CMGame.offscreenToastElement||(CMGame.offscreenToastElement=document.createElement("span"),CMGame.offscreenToastElement.setAttribute("id","cmOffscreenToast"),CMGame.offscreenToastElement.classList.add("cm-toast"),CMGame.offscreenToastElement.style.display="inline-block",CMGame.offscreenToastElement.style.left="-100vw",CMGame.offscreenToastElement.style.top="-100vh",documentBody.appendChild(CMGame.offscreenToastElement)),CMGame.showToast=function(t,e=0,i="auto",s=CMGame.noop){let n;CMGame.offscreenToastElement.innerHTML=t,CMGame.toastElement.innerHTML=t,n="number"==typeof i?i/1e3:2+Math.ceil(.3*t.split(/\s|(<br>)|(<br\/>)/).length);let a=function(t){s.call(CMGame.toastElement,t),CMGame.toastElement.removeEventListener("animationend",a,!1)};CMGame.toastElement.addEventListener("animationend",a,!1),setTimeout(function(){let t=CMGame.offscreenToastElement.getBoundingClientRect(),e=window.getComputedStyle(CMGame.offscreenToastElement).getPropertyValue("width").replace("px",""),i=parseFloat(e)||0,s=Math.max(t.right-t.left,i);CMGame.toastElement.style.opacity="0",CMGame.toastElement.style.display="none",CMGame.toastElement.style.left=`calc(50vw - ${.5*s}px)`,CMGame.toastElement.style.animationDuration=CMGame.toastElement.style.webkitAnimationDuration=`${n}s`,CMGame.toastElement.style.display="inline-block"},e)},CMGame.showToasts=function(t,e=0){let i=e,s=4e3;for(let e=0;e<t.length;e++)s=2e3+1e3*Math.ceil(.3*t[e].split(/\s|(<br>)|(<br\/>)/).length),function(e,i){setTimeout(function(){CMGame.showToast(t[e])},i)}(e,i),i+=s+1e3},CMGame.Sprite=class{constructor(t,e,i,s,n,a=null,h="none",o=0,r=!1){this.game=t,this.x=e,this.y=i,this.boundingRulePrivate=h,this.boundingRuleTop="none",this.boundingRuleRight="none",this.boundingRuleBottom="none",this.boundingRuleLeft="none",this.boundingRule=h,this.shape,this.width,this.height,this.radius,"circle"===n?(this.shape="circle",this.radius=s,this.width=2*this.radius,this.height=2*this.radius):"line"===n?(this.shape="line",this.width=s,this.height=s,this.radius=0,this.start={x:e,y:i},this.end={x:e+s,y:i}):(this.shape="rect",this.width=s,this.height=n,this.radius=Math.hypot(this.width,this.height)),this.image=null,this.fillStyle="black","string"==typeof a?this.fillStyle=a:a instanceof CMImage?this.image=a:"function"==typeof a&&(this.draw=a.bind(this)),this.velocity=new CMPoint,this.acceleration=new CMPoint,this.onupdate=CMGame.noop,this.ondraw=CMGame.noop,this.layer=o,this.onscreen=!1,this.x>this.game.width||this.y>this.game.height||this.x+this.width<0||this.y+this.height<0?this.onscreen=!1:this.onscreen=!0,this.pathFunction=null,this.hitbox=null;let l=this;!function(){let t=null;Object.defineProperty(l,"hitbox",{set(e){t=e},get(){switch(typeof t){case"function":return t.call(l);case"object":return t;default:return this}}})}()}destroy(){this.game.sprites.splice(this.game.sprites.indexOf(this),1)}setPath(t){t instanceof CMGame.Function?(this.pathFunction=t,this.pathFunction.animationTime=0,this.pathFunction.velocity.animationTime=1):Array.isArray(t)?(this.velocity.x=t[0],this.velocity.y=t[1],this.velocity.z=t[2]||0,this.pathFunction=null):(this.velocity.x=t.x||0,this.velocity.y=t.y||0,this.velocity.z=t.z||0,this.pathFunction=null)}update(){if(this.pathFunction instanceof CMGame.Function){switch(this.pathFunction.update(),this.pathFunction.type){case"xofy":this.y=this.game.yToScreen(this.pathFunction.end.y),this.x=this.game.xToScreen(this.pathFunction.of(this.pathFunction.end.y));break;case"polar":let t=this.game.fromPolar(this.pathFunction.of(this.pathFunction.end.theta),this.pathFunction.end.theta);this.x=this.game.xToScreen(t.x),this.y=this.game.yToScreen(t.y);break;case"parametric":let e=this.pathFunction.of(this.pathFunction.end.t);this.x=this.game.xToScreen(e.x),this.y=this.game.yToScreen(e.y);break;case"cartesian":default:this.x=this.game.xToScreen(this.pathFunction.end.x),this.y=this.game.yToScreen(this.pathFunction.of(this.pathFunction.end.x))}this.x-=.5*this.width,this.y-=.5*this.height}else this.velocity.x+=this.acceleration.x,this.velocity.y+=this.acceleration.y,this.velocity.z&&this.acceleration.z&&(this.velocity.z+=this.acceleration.z),this.x+=this.velocity.x,this.y+=this.velocity.y,this.velocity.z&&(this.z+=this.velocity.z);"rect"===this.shape?this.boundAsRect():"line"===this.shape?this.boundAsLine():this.boundAsCircle(),this.onupdate()}boundAsLine(){let t={x:Math.min(this.start.x,this.end.x),y:Math.min(this.start.y,this.end.y),width:Math.abs(this.end.x-this.start.x),height:Math.abs(this.end.y-this.start.y)};this.boundAsRect(t)}boundAsCircle(){if(this.x<=this.radius)switch(this.boundingRuleLeft){case"wraparound":this.x<=-this.radius&&(this.x=this.game.width+this.radius);break;case"bounce":this.x=this.radius,this.velocity.x=Math.abs(this.velocity.x);break;case"clip":this.x=this.radius;break;case"destroy":this.x<this.radius&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleLeft&&this.boundingRuleLeft.call(this)}else if(this.x+this.radius>=this.game.width)switch(this.boundingRuleRight){case"wraparound":this.x-this.radius>=this.game.width&&(this.x=-this.radius);break;case"bounce":this.x=this.game.width-this.radius,this.velocity.x=-Math.abs(this.velocity.x);break;case"clip":this.x=this.game.width-this.radius;break;case"destroy":this.x-this.radius>this.game.width&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleRight&&this.boundingRuleRight.call(this)}else if(this.y-this.radius<=0)switch(this.boundingRuleTop){case"wraparound":this.y+this.radius<=0&&(this.y=this.game.height+this.radius);break;case"bounce":this.y=this.radius,this.velocity.y=Math.abs(this.velocity.y);break;case"clip":this.y=this.radius;break;case"destroy":this.y+this.radius<0&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleTop&&this.boundingRuleTop.call(this)}else if(this.y+this.radius>=this.game.height)switch(this.boundingRuleBottom){case"wraparound":this.y-this.radius>=this.game.height&&(this.y=-this.radius);break;case"bounce":this.y=this.game.height-this.radius,this.velocity.y=-Math.abs(this.velocity.y);break;case"clip":this.y=this.game.height-this.radius;break;case"destroy":this.y-this.radius>this.game.height&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleBottom&&this.boundingRuleBottom.call(this)}this.x-this.radius>this.game.width||this.y-this.radius>this.game.height||this.x+this.radius<0||this.y+this.radius<0?this.onscreen=!1:this.onscreen=!0}boundAsRect(t=this){if(t.x<=0)switch(this.boundingRuleLeft){case"wraparound":t.x+t.width<=0&&(t.x=this.game.width);break;case"bounce":t.x=0,this.velocity.x=Math.abs(this.velocity.x);break;case"clip":t.x=0;break;case"destroy":t.x+t.width<0&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleLeft&&this.boundingRuleLeft.call(this)}else if(t.x+t.width>=this.game.width)switch(this.boundingRuleRight){case"wraparound":t.x>=this.game.width&&(t.x=0);break;case"bounce":t.x=this.game.width-t.width,this.velocity.x=-Math.abs(this.velocity.x);break;case"clip":t.x=this.game.width-t.width;break;case"destroy":t.x>this.game.width&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleRight&&this.boundingRuleRight.call(this)}else if(t.y<=0)switch(this.boundingRuleTop){case"wraparound":t.y+t.height<=0&&(t.y=this.game.height);break;case"bounce":t.y=0,this.velocity.y=Math.abs(this.velocity.y);break;case"clip":t.y=0;break;case"destroy":t.y+t.height<0&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleTop&&this.boundingRuleTop.call(this)}else if(t.y+t.height>=this.game.height)switch(this.boundingRuleBottom){case"wraparound":t.y>=this.game.height&&(t.y=0);break;case"bounce":t.y=this.game.height-t.height,this.velocity.y=-Math.abs(this.velocity.y);break;case"clip":t.y=this.game.height-t.height;break;case"destroy":t.y>this.game.height&&this.destroy();break;case"none":break;default:"function"==typeof this.boundingRuleBottom&&this.boundingRuleBottom.call(this)}this.x>this.game.width||this.y>this.game.height||this.x+this.width<0||this.y+this.height<0?this.onscreen=!1:this.onscreen=!0}draw(t){this.pathFunction instanceof CMGame.Function&&this.pathFunction.draw(t),this.image?t.drawImage(this.image,this.x,this.y,this.width,this.height):"circle"===this.shape?(t.fillStyle=this.fillStyle,this.game.fillOval(this.x,this.y,this.radius)):"line"===this.shape?(t.lineWidth=this.width,this.game.drawLine(this.start,this.end)):(t.fillStyle=this.fillStyle,t.fillRect(this.x,this.y,this.width,this.height)),this.ondraw(t)}containsPoint(t,e){let i=null;return i="number"==typeof t?{x:t,y:e}:t,"circle"===this.shape?this.game.distance(this,i)<=this.radius:"line"===this.shape?(this.game.ctx.lineWidth=this.width,this.game.ctx.isPointInStroke(this.path,i.x,i.y)):this.game.areColliding(this,{x:i.x,y:i.y,width:1,height:1})}},Object.defineProperty(CMGame.Sprite.prototype,"center",{get(){return"rect"===this.shape?new CMPoint(this.x+.5*this.width,this.y+.5*this.height):"line"===this.shape?CMGame.midpoint(this.start,this.end):new CMPoint(this.x,this.y)}}),Object.defineProperty(CMGame.Sprite.prototype,"boundingRule",{get(){return this.boundingRulePrivate},set(t){this.boundingRulePrivate=t,Array.isArray(t)?[this.boundingRuleTop,this.boundingRuleRight,this.boundingRuleBottom,this.boundingRuleLeft]=t:[this.boundingRuleTop,this.boundingRuleRight,this.boundingRuleBottom,this.boundingRuleLeft]=new Array(4).fill(t)}}),CMGame.factorial=(t=>{let e=1;for(let i=1;i<=t;i++)e*=i;return e}),CMGame.P=((t,e)=>{return CMGame.factorial(t)/CMGame.factorial(t-e)}),CMGame.C=((t,e)=>{return CMGame.factorial(t)/(CMGame.factorial(e)*CMGame.factorial(t-e))}),CMGame.sum=function(t,e=0,i=0){if("function"!=typeof t)return function(...t){return t.reduce((t,e)=>t+e)}(...arguments);let s=0,n=t(e),a=s+n;if(Number.isFinite(i))for(let n=e;n<=i;n++)s+=t(n);else try{for(let h=e;h<=i&&a<Number.EPSILON;h++)a=(s+=n)+(n=t(h+1))}catch(t){return}return s},CMGame.mean=((...t)=>CMGame.sum(...t)/t.length),CMGame.midpoint=((t,e)=>new Point(CMGame.mean(t.x,e.x),CMGame.mean(t.y,e.y))),CMGame.Function=class{constructor(t,e,i={}){this.game=t,this.type=i.type||"cartesian",this.lineWidth=i.lineWidth||1,this.of=e,this.scaledOf=null,this.tStep=0,this.thetaStep=0,this.strokeStyle=i.strokeStyle||CMGame.Color.DARK_GRAY,this.fillStyleBelow=i.fillStyleBelow,this.fillStyleAbove=i.fillStyleAbove,this.name=i.name||"",void 0!==i.color&&console.warn('"color" is not a valid option for CMGame.Function. Use "strokeStyle" instead.'),this.animationTime=0,this.start={t:0,x:-this.game.origin.x/this.game.graphScalar,y:-(this.game.height-this.game.origin.y)/this.game.graphScalar,r:0,theta:0},i.start||(i.start={});for(let t in i.start)this.start[t]=i.start[t];this.end={t:0,x:(this.game.width-this.game.origin.x)/this.game.graphScalar,y:t.origin.y/t.graphScalar,r:0,theta:Math.TAU},i.end||(i.end={});for(let t in i.end)this.end[t]=i.end[t];this.velocity={animationTime:0,start:{t:0,x:0,y:0,r:0,theta:0},end:{t:0,x:0,y:0,r:0,theta:0}},i.velocity||(i.velocity={});for(let t in i.velocity)if("start"===t||"end"===t)for(let e in i.velocity[t])this.velocity[t][e]=i.velocity[t][e];else this.velocity[t]=i.velocity[t];this.onupdate=i.onupdate||CMGame.noop,this.ondraw=i.ondraw||CMGame.noop,this.path=new Path2D,this.pathAbove=null,this.pathBelow=null;let s=this;switch(this.valsArray=null,this.static=!!i.static,this.type){case"xofy":s.scaledOf=function(e){return t.xToScreen(s.of(e))};break;case"polar":s.thetaStep="number"==typeof i.thetaStep?i.thetaStep:Math.TAU/360,s.scaledOf=function(t){return s.of(t)*s.game.graphScalar};break;case"parametric":s.tStep="number"==typeof i.tStep?i.tStep:.1,s.scaledOf=function(e){let i=s.of(e);return{x:t.xToScreen(i.x),y:t.yToScreen(i.y)}};break;case"cartesian":default:s.scaledOf=function(e){return t.yToScreen(s.of(e))}}this.scaledValsArray=null,this.static&&(this.buildGraphPath(this.game.ctx),this.draw=this.drawGraphPath),this.continuous=!0}updateBoundsOnResize(t){this.game.origin.x-t*this.start.x==0&&(this.start.x=-this.game.origin.x/this.game.graphScalar),this.game.origin.x+t*this.end.x===this.game.canvas.width&&(this.end.x=(this.game.width-this.game.origin.x)/this.game.graphScalar),this.game.origin.y-t*this.start.y==0&&(this.start.y=-(this.game.height-this.game.origin.y)/this.game.graphScalar),this.game.origin.y-t*this.end.y===this.game.canvas.height&&(this.end.y=this.game.origin.y/this.game.graphScalar)}buildGraphPath(t){let e,i,s,n,a,h=this.game,o=h.canvas;switch(this.path=new Path2D,this.type){case"cartesian":s=((e=Math.max(0,this.game.xToScreen(this.start.x)))-h.origin.x)/h.graphScalar,i=Math.min(o.width,this.game.xToScreen(this.end.x)),this.path.moveTo(e,this.scaledOf(s));for(let t=e+1;t<=i;t++){let e=(t-h.origin.x)/h.graphScalar,i=(t-1-h.origin.x)/h.graphScalar;this.scaledOf(e)<0&&this.scaledOf(i)>o.height||this.scaledOf(i)<0&&this.scaledOf(e)>o.height?(this.continuous=!1,this.path.moveTo(t,this.scaledOf(e))):this.path.lineTo(t,this.scaledOf(e))}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.lineTo(i,o.height+t.lineWidth),this.pathBelow.lineTo(o.width,o.height+t.lineWidth),this.pathBelow.lineTo(e,o.height+t.lineWidth),this.pathBelow.closePath()),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.lineTo(i,0-t.lineWidth),this.pathAbove.lineTo(e,0-t.lineWidth),this.pathAbove.closePath());break;case"xofy":n=((e=Math.max(0,h.height-h.yToScreen(this.start.y)))-h.origin.y)/h.graphScalar,i=Math.min(h.height,h.height-h.yToScreen(this.end.y)),this.path.moveTo(this.scaledOf(n),h.height-e);for(let t=e+1;t<=i;t++){let e=-(h.height-t-h.origin.y)/h.graphScalar,i=-(h.origin.y-(t-1))/h.graphScalar;this.scaledOf(e)<0&&this.scaledOf(i)>o.width||this.scaledOf(i)<0&&this.scaledOf(e)>o.width?(this.continuous=!1,this.path.moveTo(this.scaledOf(e),h.height-t)):this.path.lineTo(this.scaledOf(e),h.height-t)}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.lineTo(-t.lineWidth,h.height-i),this.pathBelow.lineTo(-t.lineWidth,h.height-e),this.pathBelow.closePath()),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.lineTo(o.width+t.lineWidth,h.height-i),this.pathAbove.lineTo(o.width+t.lineWidth,h.height-e),this.pathAbove.closePath());break;case"polar":a=h.fromPolar({r:this.scaledOf(0),theta:0}),this.path.moveTo(h.origin.x+a.x,h.origin.y-a.y);for(let t=this.thetaStep;t<=Math.TAU;t+=this.thetaStep){let e=h.fromPolar({r:this.scaledOf(t),theta:t});this.path.lineTo(h.origin.x+e.x,h.origin.y-e.y)}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.closePath()),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.moveTo(h.width+t.lineWidth,h.origin.y-a.y),this.pathAbove.lineTo(h.width+t.lineWidth,h.height+t.lineWidth),this.pathAbove.lineTo(0-t.lineWidth,h.height+t.lineWidth),this.pathAbove.lineTo(0-t.lineWidth,0-t.lineWidth),this.pathAbove.lineTo(h.width+t.lineWidth,0-t.lineWidth),this.pathAbove.lineTo(h.width+t.lineWidth,h.origin.y-a.y));break;case"parametric":a=this.scaledOf(0),this.path.moveTo(a.x,a.y);for(let t=this.tStep;t<this.end.t;t+=this.tStep){let e=this.scaledOf(t);this.path.lineTo(e.x,e.y)}}}drawGraphPath(t=this.game.offscreenCtx){this.pathBelow&&(t.fillStyle=this.fillStyleBelow,t.fill(this.pathBelow)),this.pathAbove&&(t.fillStyle=this.fillStyleAbove,t.fill(this.pathAbove)),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke(this.path),this.ondraw(t)}update(t){for(let t in this.velocity)if("start"===t||"end"===t)for(let e in this.velocity[t])this[t][e]+=this.velocity[t][e];else this[t]+=this.velocity[t];this.onupdate(t)}draw(t){switch(this.type){case"cartesian":return this.drawCartesian(t);case"polar":return this.drawPolar(t);case"parametric":return this.drawParametric(t);case"xofy":return this.drawXOfY(t)}this.ondraw(t)}drawPolar(t){let e=this.game,i=(e.canvas,e.fromPolar({r:this.scaledOf(0),theta:0}));this.path=new Path2D,this.path.moveTo(e.origin.x+i.x,e.origin.y-i.y);for(let t=this.thetaStep;t<=Math.TAU;t+=this.thetaStep){let i=e.fromPolar({r:this.scaledOf(t),theta:t});this.path.lineTo(e.origin.x+i.x,e.origin.y-i.y)}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.closePath(),t.fillStyle=this.fillStyleBelow,t.fill(this.pathBelow)),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.moveTo(e.width+t.lineWidth,e.origin.y-i.y),this.pathAbove.lineTo(e.width+t.lineWidth,e.height+t.lineWidth),this.pathAbove.lineTo(0-t.lineWidth,e.height+t.lineWidth),this.pathAbove.lineTo(0-t.lineWidth,0-t.lineWidth),this.pathAbove.lineTo(e.width+t.lineWidth,0-t.lineWidth),this.pathAbove.lineTo(e.width+t.lineWidth,e.origin.y-i.y),t.fillStyle=this.fillStyleAbove,t.fill(this.pathAbove)),t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke(this.path)}drawParametric(t){this.game.canvas;let e=this.scaledOf(0);this.path=new Path2D,this.path.moveTo(e.x,e.y);for(let t=this.tStep;t<this.end.t;t+=this.tStep){let e=this.scaledOf(t);this.path.lineTo(e.x,e.y)}t.beginPath(),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke(this.path)}drawXOfY(t){let e=this.game,i=e.canvas,s=Math.max(0,e.height-e.yToScreen(this.start.y)),n=(s-e.origin.y)/e.graphScalar,a=Math.min(e.height,e.height-e.yToScreen(this.end.y));this.path=new Path2D,this.path.moveTo(this.scaledOf(n),e.height-s);for(let n=s+1;n<=a;n++){let s=-(e.height-n-e.origin.y)/e.graphScalar,a=-(e.origin.y-(n-1))/e.graphScalar;this.scaledOf(s)<0&&this.scaledOf(a)>i.width||this.scaledOf(a)<0&&this.scaledOf(s)>i.width?(t.stroke(this.path),this.continuous=!1,this.path.moveTo(this.scaledOf(s),e.height-n)):this.path.lineTo(this.scaledOf(s),e.height-n)}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.lineTo(-t.lineWidth,e.height-a),this.pathBelow.lineTo(-t.lineWidth,e.height-s),this.pathBelow.closePath(),t.fillStyle=this.fillStyleBelow,t.fill(this.pathBelow)),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.lineTo(i.width+t.lineWidth,e.height-a),this.pathAbove.lineTo(i.width+t.lineWidth,e.height-s),this.pathAbove.closePath(),t.fillStyle=this.fillStyleAbove,t.fill(this.pathAbove)),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke(this.path),this.ondraw(t)}drawCartesian(t){let e=this.game,i=e.canvas,s=Math.max(0,e.xToScreen(this.start.x)),n=(s-e.origin.x)/e.graphScalar,a=Math.min(i.width,e.xToScreen(this.end.x));this.path=new Path2D,this.path.moveTo(s,this.scaledOf(n));for(let n=s+1;n<=a;n++){let s=(n-e.origin.x)/e.graphScalar,a=(n-1-e.origin.x)/e.graphScalar;this.scaledOf(s)<0&&this.scaledOf(a)>i.height||this.scaledOf(a)<0&&this.scaledOf(s)>i.height?(t.stroke(this.path),this.continuous=!1,this.path.moveTo(n,this.scaledOf(s))):this.path.lineTo(n,this.scaledOf(s))}this.fillStyleBelow&&this.fillStyleBelow!==CMGame.Color.TRANSPARENT&&(this.pathBelow=new Path2D(this.path),this.pathBelow.lineTo(a,i.height+t.lineWidth),this.pathBelow.lineTo(s,i.height+t.lineWidth),this.pathBelow.closePath(),t.fillStyle=this.fillStyleBelow,t.fill(this.pathBelow)),this.fillStyleAbove&&this.fillStyleAbove!==CMGame.Color.TRANSPARENT&&(this.pathAbove=new Path2D(this.path),this.pathAbove.lineTo(a,0-t.lineWidth),this.pathAbove.lineTo(s,0-t.lineWidth),this.pathAbove.closePath(),t.fillStyle=this.fillStyleAbove,t.fill(this.pathAbove)),t.lineWidth=this.lineWidth,t.strokeStyle=this.strokeStyle,t.stroke(this.path),this.ondraw(t)}positionOf(t,e){let i={};if("number"==typeof t?(i.x=t,i.y=e):i=t,this.continuous){let t=this.game.ctx;if(t.isPointInStroke(this.path,i.x,i.y))return"on";if(t.isPointInPath(this.pathAbove,i.x,i.y))return"above";if(t.isPointInPath(this.pathBelow,i.x,i.y))return"below";{let t="color: rgb(225, 225, 0)",e="color: rgb(225, 225, 0)";return(i.x<0||i.x>canvas.width)&&(t="color: rgb(255, 95, 95)"),(i.y<0||i.y>canvas.height)&&(e="color: rgb(255, 95, 95)"),console.log(`Point (%c${i.x}%c, %c${i.y}%c) is outside canvas`,t,"color: default",e,"color: default"),"unknown"}}{let t=this.of(this.game.xToReal(i.x)),e=this.game.yToReal(i.y);return e===t?"on":e>t?"above":e<t?"below":"uknown"}}};class VennRegion extends CMGame.Sprite{constructor(t,e,i=0){super(t,0,0,0,"circle",null,"none",0,!0),this.regionCode=e,this.variation=i,this.filled=!1,this.fillStyle="red",this.path=new Path2D,this.label={text:"",x:0,y:0,active:!1,fillStyle:CMGame.Color.BLACK};let s=Math.floor(this.game.width/16);switch(this.game.ctx.font=`italic ${s}px Times New Roman, serif`,this.regionCode){case"":this.label.text="I",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.5*this.game.height;break;case"0":this.label.text="I",this.label.x=.15*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.25*this.game.height;break;case"1":this.label.text="II",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.5*this.game.height;break;case"00":case"0S0":this.label.text="I",this.label.x=.15*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.2*this.game.height;break;case"10":this.label.text="II",this.label.x=.25*this.game.width-.5*this.game.ctx.measureText("II").width,this.label.y=.5*this.game.height;break;case"01":this.label.text="III",this.label.x=.75*this.game.width-.5*this.game.ctx.measureText("III").width,this.label.y=.5*this.game.height;break;case"0S1":this.label.text="II",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("II").width,this.label.y=.25*this.game.height;break;case"11":this.label.text="IV",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("IV").width,this.label.y=.5*this.game.height;break;case"1S1":this.label.text="III",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("III").width,this.label.y=.6*this.game.height;break;case"0S0S0":this.label.text="I",this.label.x=.15*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.2*this.game.height;break;case"0S0S1":this.label.text="II",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("II").width,this.label.y=95;break;case"0S1S1":this.label.text="III",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("III").width,this.label.y=182;break;case"1S1S1":this.label.text="IV",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("IV").width,this.label.y=292;break;case"000":this.label.text="I",this.label.x=.15*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.2*this.game.height;break;case"100":this.label.text="II",this.label.x=.25*this.game.width-.5*this.game.ctx.measureText("II").width,this.label.y=.7*this.game.height;break;case"010":this.label.text="III",this.label.x=.75*this.game.width-.5*this.game.ctx.measureText("III").width,this.label.y=.7*this.game.height;break;case"001":this.label.text="IV",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("IV").width,this.label.y=.2*this.game.height;break;case"110":this.label.text="V",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("V").width,this.label.y=.775*this.game.height;break;case"101":this.label.text="VI",this.label.x=.35*this.game.width-.5*this.game.ctx.measureText("VI").width,this.label.y=.45*this.game.height;break;case"011":this.label.text="VII",this.label.x=.65*this.game.width-.5*this.game.ctx.measureText("VII").width,this.label.y=.45*this.game.height;break;case"111":this.label.text="VIII",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("VIII").width,this.label.y=.525*this.game.height}if(2===i)switch(this.regionCode){case"000":this.label.text="I",this.label.x=.075*this.game.width-.5*this.game.ctx.measureText("I").width,this.label.y=.2*this.game.height;break;case"100":this.label.text="II",this.label.x=.2875*this.game.width-.5*this.game.ctx.measureText("II").width,this.label.y=.25*this.game.height;break;case"010":this.label.text="III",this.label.x=.7125*this.game.width-.5*this.game.ctx.measureText("III").width,this.label.y=.25*this.game.height;break;case"001":this.label.text="IV",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("IV").width,this.label.y=.7875*this.game.height;break;case"110":this.label.text="V",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("V").width,this.label.y=.225*this.game.height;break;case"101":this.label.text="VI",this.label.x=.35*this.game.width-.5*this.game.ctx.measureText("VI").width,this.label.y=.55*this.game.height;break;case"011":this.label.text="VII",this.label.x=.65*this.game.width-.5*this.game.ctx.measureText("VII").width,this.label.y=.55*this.game.height;break;case"111":this.label.text="VIII",this.label.x=.5*this.game.width-.5*this.game.ctx.measureText("VIII").width,this.label.y=.47*this.game.height}}containsPoint(t,e){let i,s,n,a=null;switch(a="number"==typeof t?{x:t,y:e}:t,this.regionCode){case"":return!0;case"0":return!(i=this.game.vennSets.get("A")).containsPoint(t,e);case"1":return(i=this.game.vennSets.get("A")).containsPoint(t,e);case"00":case"0S0":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),!(i.containsPoint(t,e)||s.containsPoint(t,e));case"10":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),i.containsPoint(t,e)&&!s.containsPoint(t,e);case"01":case"0S1":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),!i.containsPoint(t,e)&&s.containsPoint(t,e);case"11":case"1S1":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),i.containsPoint(t,e)&&s.containsPoint(t,e);case"000":case"0S0S0":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),!(i.containsPoint(t,e)||s.containsPoint(t,e)||n.containsPoint(t,e));case"100":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),i.containsPoint(t,e)&&!s.containsPoint(t,e)&&!n.containsPoint(t,e);case"010":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),!i.containsPoint(t,e)&&s.containsPoint(t,e)&&!n.containsPoint(t,e);case"001":case"0S0S1":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),!i.containsPoint(t,e)&&!s.containsPoint(t,e)&&n.containsPoint(t,e);case"110":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),i.containsPoint(t,e)&&s.containsPoint(t,e)&&!n.containsPoint(t,e);case"101":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),i.containsPoint(t,e)&&!s.containsPoint(t,e)&&n.containsPoint(t,e);case"011":case"0S1S1":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),!i.containsPoint(t,e)&&s.containsPoint(t,e)&&n.containsPoint(t,e);case"100":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),i.containsPoint(t,e)&&!s.containsPoint(t,e)&&!n.containsPoint(t,e);case"010":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),!i.containsPoint(t,e)&&s.containsPoint(t,e)&&!n.containsPoint(t,e);case"111":case"1S1S1":return i=this.game.vennSets.get("A"),s=this.game.vennSets.get("B"),n=this.game.vennSets.get("C"),i.containsPoint(t,e)&&s.containsPoint(t,e)&&n.containsPoint(t,e)}}draw(t){if(this.filled){let e,i,s,n,a,h,o,r,l;switch(t.save(),t.fillStyle=this.fillStyle,this.regionCode){case"":t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"0":(e=this.game.vennSets.get("A")).drawComplement(t);break;case"1":case"1S1":case"1S1S1":e=this.game.vennSets.get("A"),t.fill(e.getPath(t));break;case"10":e=this.game.vennSets.get("A"),r=(i=this.game.vennSets.get("B")).getComplementPath(t),t.clip(r),t.beginPath(),t.arc(e.x,e.y,e.radius,0,Math.TAU,!1),t.fill();break;case"01":case"0S1":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),o=e.getComplementPath(t),t.clip(o),t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.TAU,!1),t.fill();break;case"11":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),t.beginPath(),t.arc(e.x,e.y,e.radius,0,Math.TAU,!1),t.clip(),t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.TAU,!1),t.clip(),t.fill();break;case"00":case"0S0":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),o=e.getComplementPath(t),r=i.getComplementPath(t),t.clip(o),t.clip(r),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"0S0S0":(s=this.game.vennSets.get("C")).drawComplement(t);break;case"000":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),o=e.getComplementPath(t),r=i.getComplementPath(t),l=s.getComplementPath(t),t.clip(o),t.clip(r),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"100":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),n=e.getPath(t),r=i.getComplementPath(t),l=s.getComplementPath(t),t.clip(n),t.clip(r),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"010":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),o=e.getComplementPath(t),a=i.getPath(t),l=s.getComplementPath(t),t.clip(o),t.clip(a),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"001":case"0S0S1":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),o=e.getComplementPath(t),r=i.getComplementPath(t),h=s.getPath(t),t.clip(o),t.clip(r),t.clip(h),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"110":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),n=e.getPath(t),a=i.getPath(t),l=s.getComplementPath(t),t.clip(n),t.clip(a),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"101":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),n=e.getPath(t),r=i.getComplementPath(t),h=s.getPath(t),t.clip(n),t.clip(r),t.clip(h),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"011":case"0S1S1":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),o=e.getComplementPath(t),a=i.getPath(t),h=s.getPath(t),t.clip(o),t.clip(a),t.clip(h),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"100":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),n=e.getPath(t),r=i.getComplementPath(t),l=s.getComplementPath(t),t.clip(n),t.clip(r),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"010":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),o=e.getComplementPath(t),a=i.getPath(t),l=s.getComplementPath(t),t.clip(o),t.clip(a),t.clip(l),t.fillRect(0,0,this.game.canvas.width,this.game.canvas.height);break;case"111":e=this.game.vennSets.get("A"),i=this.game.vennSets.get("B"),s=this.game.vennSets.get("C"),t.beginPath(),t.arc(e.x,e.y,e.radius,0,Math.TAU,!1),t.clip(),t.beginPath(),t.arc(i.x,i.y,i.radius,0,Math.TAU,!1),t.clip(),t.beginPath(),t.arc(s.x,s.y,s.radius,0,Math.TAU,!1),t.fill()}t.restore()}if(this.label.active){t.save();let e=Math.floor(this.game.width/16);t.font=`italic ${e}px Times New Roman, serif`,t.textBaseline="middle",t.fillStyle=this.label.fillStyle,t.fillText(this.label.text,this.label.x,this.label.y),t.restore()}}}class VennSet extends CMGame.Sprite{constructor(t,e,i,s,n){super(t,e,i,s,"circle",null,"none",1,!0),this.path=null,this.complementPath=null,this.label={text:"",x:e+.75*s,y:i+s,active:!1,fillStyle:CMGame.Color.BLACK},n&&(this.label.active=!0,this.label.x=n.x||this.label.x,this.label.y=n.y||this.label.y,this.label.text=n.text||this.label.text)}containsPoint(t,e){let i=null;return i="number"==typeof t?{x:t,y:e}:t,this.game.distance(this,i)<=this.radius}update(t){}draw(t){if(t.save(),t.strokeStyle=t.fillStyle=CMGame.Color.BLACK,t.lineWidth=1.5,this.game.strokeOval(this.x,this.y,this.radius),this.label.active){let e=Math.floor(this.game.width/16);t.font=`italic ${e}px Times New Roman, serif`,t.textBaseline="middle",t.fillStyle=this.label.fillStyle,t.fillText(this.label.text,this.label.x,this.label.y)}t.restore()}drawComplement(t){t.fill(this.getComplementPath(t))}getPath(t,e=!1){return this.path&&!e?this.path:(this.path=new Path2D,this.path.arc(this.x,this.y,this.radius,0,Math.TAU,!1),this.path)}getComplementPath(t,e=!1){return this.complementPath&&!e?this.complementPath:(this.complementPath=new Path2D,this.complementPath.moveTo(0,0),this.complementPath.lineTo(this.game.canvas.width,0),this.complementPath.lineTo(this.game.canvas.width,this.game.canvas.height),this.complementPath.lineTo(0,this.game.canvas.height),this.complementPath.lineTo(0,this.y),this.complementPath.lineTo(this.x-this.radius,this.y),this.complementPath.arc(this.x,this.y,this.radius,0,Math.TAU,!0),this.complementPath.lineTo(0,this.y),this.complementPath.closePath(),this.complementPath)}}class CMVertex extends CMGame.Sprite{constructor(t,e,i,s,n=CMGame.Color.BLACK,a){if(super(t,e,i,s,"circle",n,"none",1,!0),this.degree=0,this.adjacentVertices=[],this.incidentEdges=[],this.label={text:"",x:0,y:0,active:!1,fillStyle:this.fillStyle,font:.5*s+"px Times New Roman, serif"},a){for(let t in a)this.label[t]=a[t];a.text&&void 0===a.active&&(this.label.active=!0)}}update(){super.update();for(let t of this.incidentEdges)this===t.vertex1?(t.start.x=this.x,t.start.y=this.y):this===t.vertex2&&(t.end.x=this.x,t.end.y=this.y)}adjacentTo(t){return this.adjacentVertices.includes(t)}incidentTo(t){return this.incidentEdges.includes(t)}draw(t){super.draw(t),this.label.active&&(t.fillStyle=this.label.fillStyle,t.font=this.label.font,t.fillText(this.label.text,this.label.x,this.label.y))}}class CMEdge extends CMGame.Sprite{constructor(t,e=null,i=null,s=1,n=CMGame.Color.BLACK,a={},h=!1,o){if(super(t,0,0,s,"line",n,"none",0,!0),this.vertex1=e,this.vertex2=i,this.directed=h,this.weight=o,this.incidentVertices=[],this.incidentEdges=[],this.length=0,this.start={x:0,y:0},this.end={x:0,y:0},this.vertex1){this.vertex1.incidentEdges.push(this);for(let t of this.vertex1.incidentEdges)this.incidentEdges.includes(t)||t===this||this.incidentEdges.push(t);this.start={x:this.vertex1.x,y:this.vertex1.y},this.x=this.start.x,this.y=this.start.y}if(this.vertex2){this.vertex2.incidentEdges.push(this);for(let t of this.vertex2.incidentEdges)this.incidentEdges.includes(t)||t===this||this.incidentEdges.push(t);this.end={x:this.vertex2.x,y:this.vertex2.y}}else this.end={x:this.start.x,y:this.start.y};if(this.length=this.game.distance(this.start,this.end),this.path=new Path2D,this.arrowPath=new Path2D,this.rebuildPath(),this.vertex1&&this.vertex2&&(this.vertex1.adjacentVertices.includes(this.vertex2)||(this.vertex1.adjacentVertices.push(this.vertex2),this.vertex1.degree++),this.vertex2.adjacentVertices.includes(this.vertex1)||(this.vertex2.adjacentVertices.push(this.vertex1),this.vertex2.degree++)),this.label={text:"",x:0,y:0,active:!1,fillStyle:this.fillStyle,font:Math.max(5*s,16)+"px Times New Roman, serif"},a){for(let t in a)this.label[t]=a[t];a.text&&void 0===a.active&&(this.label.active=!0)}}changeDirection(){let t=this.game.vertices.indexOf(this.vertex1),e=this.game.vertices.indexOf(this.vertex2);this.vertex1=this.game.vertices[e],this.vertex2=this.game.vertices[t],this.vertex1&&(this.start={x:this.vertex1.x,y:this.vertex1.y},this.x=this.start.x,this.y=this.start.y),this.vertex2?this.end={x:this.vertex2.x,y:this.vertex2.y}:this.end={x:this.start.x,y:this.start.y},this.rebuildPath()}rebuildPath(){this.path=new Path2D,this.path.moveTo(this.start.x,this.start.y);let t=null,e=0,i=0,s=0,n=0;if(this.directed){for(t={x:this.end.x,y:this.end.y},e=this.game.slopeToRadians(this.game.getSlope(this.start,this.end)),this.end.x<this.start.x&&(e+=Math.PI);e>=Math.TAU;)e-=Math.TAU;for(i=e+Math.PI;i>=Math.TAU;)i-=Math.TAU;s=1.5*this.width,n=Math.SQRT1_2*s,this.vertex2&&(t.x=this.end.x+(this.vertex2.radius+n)*Math.cos(i),t.y=this.end.y+(this.vertex2.radius+n)*Math.sin(i)),this.path.lineTo(t.x,t.y)}else this.path.lineTo(this.end.x,this.end.y);if(this.arrowPath=new Path2D,this.directed){let n=e-3*Math.PI/4,a=e+3*Math.PI/4;for(;n<0;)n+=Math.TAU;for(;a>Math.TAU;)a-=Math.TAU;this.vertex2.radius&&(t.x=this.end.x+this.vertex2.radius*Math.cos(i),t.y=this.end.y+this.vertex2.radius*Math.sin(i)),this.arrowPath.lineTo(t.x,t.y),this.arrowPath.lineTo(t.x+s*Math.cos(n),t.y+s*Math.sin(n)),this.arrowPath.lineTo(t.x+s*Math.cos(a),t.y+s*Math.sin(a)),this.vertex2.radius?this.arrowPath.lineTo(t.x,t.y):this.arrowPath.lineTo(this.end.x,this.end.y)}}update(){super.update(),this.rebuildPath()}draw(t){t.save(),t.lineWidth=this.width,t.strokeStyle=this.fillStyle,t.stroke(this.path),t.restore(),t.fillStyle=this.fillStyle,t.fill(this.arrowPath),this.label.active&&(t.fillStyle=this.label.fillStyle,t.font=this.label.font,t.fillText(this.label.text,this.label.x,this.label.y)),this.ondraw(t)}}class CMnGon extends CMGame.Sprite{constructor(t,e,i,s,n,a=0,h=CMGame.Color.BLACK,o=CMGame.Color.TRANSPARENT,r=1){super(t,i,s,n,"circle",function(t){t.fillStyle=this.fillStyle,t.fill(this.path),t.strokeStyle=this.strokeStyle,t.stroke(this.path)}),this.fillStyle=h,this.strokeStyle=o,this.lineWidth=r,this.n=e,this.rotation=a,this.rebuildPath(),this.previousState=[this.n,this.x,this.y,this.radius,this.rotation].join(";")}rebuildPath(){this.path=new Path2D;let t=Math.TAU/this.n;this.path.moveTo(this.x+this.radius*Math.cos(this.rotation),this.y+this.radius*Math.sin(this.rotation));for(let e=this.rotation;e<=this.rotation+Math.TAU;e+=t)this.path.lineTo(this.x+this.radius*Math.cos(e),this.y+this.radius*Math.sin(e))}update(){super.update(),[this.n,this.x,this.y,this.radius,this.rotation].join(";")!==this.previousState&&(this.rebuildPath(),this.previousState=[this.n,this.x,this.y,this.radius,this.rotation].join(";"))}containsPoint(t,e){let i=null;return i="number"==typeof t?{x:t,y:e}:t,this.game.ctx.isPointInPath(this.path,i.x,i.y)}}